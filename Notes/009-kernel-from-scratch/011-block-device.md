# ä»é›¶å†™ OS å†…æ ¸-ç¬¬åä¸€ç¯‡ï¼šå—è®¾å¤‡é©±åŠ¨ â€”â€” è®© OS çœŸæ­£è®¿é—®ç¡¬ç›˜ï¼

> **â€œæ–‡ä»¶ç³»ç»Ÿå†ç²¾å·§ï¼Œè‹¥æ— æ³•ä¸çœŸå®ç¡¬ä»¶å¯¹è¯ï¼Œä¹Ÿåªæ˜¯çº¸ä¸Šè°ˆå…µã€‚  
> ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸ºå†…æ ¸æ·»åŠ  IDE/ATA é©±åŠ¨ï¼Œè®© ext2 æ–‡ä»¶ç³»ç»Ÿè·‘åœ¨çœŸæ­£çš„ç£ç›˜ä¸Šï¼â€**

åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å®ç°äº† **ext2 æ–‡ä»¶ç³»ç»Ÿ**ï¼Œä½†æµ‹è¯•æ—¶ä¾èµ– QEMU æ¨¡æ‹Ÿçš„ `-hda`ã€‚  
è€Œ QEMU èƒŒåï¼Œæ˜¯å®ƒæ›¿æˆ‘ä»¬å®Œæˆäº†**ç£ç›˜ I/O**â€”â€”ä½ çš„å†…æ ¸å®é™…ä¸Šå¹¶æœªç›´æ¥æ“ä½œç¡¬ä»¶ã€‚

çœŸæ­£çš„æ“ä½œç³»ç»Ÿï¼Œå¿…é¡»èƒ½**é€šè¿‡å—è®¾å¤‡é©±åŠ¨**ï¼ˆBlock Device Driverï¼‰ï¼Œ  
ç›´æ¥ä¸ **IDE/PATAã€AHCI/SATA æˆ– NVMe** æ§åˆ¶å™¨é€šä¿¡ï¼Œè¯»å†™ç£ç›˜æ‰‡åŒºã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä»¥ **ç»å…¸ IDE/ATA æ¥å£** ä¸ºä¾‹ï¼Œå®ç°ä¸€ä¸ª**æç®€ä½†å¯ç”¨çš„å—è®¾å¤‡é©±åŠ¨**ï¼Œ  
è®©ä½ çš„ OS èƒ½ä»ç‰©ç†ç¡¬ç›˜ï¼ˆæˆ– QEMU æ¨¡æ‹Ÿçš„ IDE ç£ç›˜ï¼‰åŠ è½½ç¨‹åºï¼

---

## ğŸ’¾ ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å—è®¾å¤‡é©±åŠ¨ï¼Ÿ

æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext2ï¼‰åªå…³å¿ƒâ€œé€»è¾‘å—â€ï¼ˆä¾‹å¦‚â€œè¯»ç¬¬ 100 ä¸ªå—â€ï¼‰ï¼Œ  
ä½†**å¦‚ä½•å°†é€»è¾‘å—è½¬æ¢ä¸ºç‰©ç†ç£ç›˜æ“ä½œ**ï¼Œæ˜¯å—è®¾å¤‡é©±åŠ¨çš„èŒè´£ã€‚

### å—è®¾å¤‡é©±åŠ¨çš„æ ¸å¿ƒä»»åŠ¡ï¼š
- **æ¢æµ‹ç¡¬ä»¶**ï¼šæ£€æµ‹ IDE æ§åˆ¶å™¨å’Œè¿æ¥çš„ç£ç›˜
- **å‘é€å‘½ä»¤**ï¼šå¦‚ â€œREAD SECTORâ€ã€â€œWRITE SECTORâ€
- **ä¼ è¾“æ•°æ®**ï¼šé€šè¿‡ PIOï¼ˆProgrammed I/Oï¼‰æˆ– DMA è¯»å†™æ‰‡åŒº
- **é”™è¯¯å¤„ç†**ï¼šè¶…æ—¶ã€CRC é”™è¯¯ç­‰

> ğŸ’¡ **åˆæœŸæˆ‘ä»¬ä½¿ç”¨ PIO æ¨¡å¼**ï¼ˆç®€å•ï¼Œæ— éœ€ DMA è®¾ç½®ï¼‰ï¼Œé€‚åˆå­¦ä¹ ã€‚

---

## ğŸ”Œ äºŒã€IDE/ATA ç¡¬ä»¶æ¥å£è¯¦è§£

ç»å…¸çš„ IDE æ¥å£é€šè¿‡ **I/O ç«¯å£** é€šä¿¡ï¼Œä¸»é€šé“ç«¯å£å¦‚ä¸‹ï¼š

| ç«¯å£ï¼ˆä¸»é€šé“ï¼‰ | åç§° | ä½œç”¨ |
|----------------|------|------|
| `0x1F0` | Data | æ•°æ®å¯„å­˜å™¨ï¼ˆ16 ä½ï¼‰|
| `0x1F1` | Error | é”™è¯¯å¯„å­˜å™¨ |
| `0x1F2` | Sector Count | è¦è¯»å†™çš„æ‰‡åŒºæ•° |
| `0x1F3` | LBA Low | LBA åœ°å€ä½ 8 ä½ |
| `0x1F4` | LBA Mid | LBA åœ°å€ä¸­ 8 ä½ |
| `0x1F5` | LBA High | LBA åœ°å€é«˜ 8 ä½ |
| `0x1F6` | Drive/Head | é©±åŠ¨å™¨é€‰æ‹© + LBA é«˜ä½ |
| `0x1F7` | Status | çŠ¶æ€å¯„å­˜å™¨ï¼ˆåªè¯»ï¼‰|
| `0x1F7` | Command | å‘½ä»¤å¯„å­˜å™¨ï¼ˆåªå†™ï¼‰|

### å…³é”®çŠ¶æ€ä½ï¼ˆStatus å¯„å­˜å™¨ï¼‰ï¼š
- **BSY (bit 7)**ï¼š1 = æ§åˆ¶å™¨å¿™
- **DRQ (bit 3)**ï¼š1 = æ•°æ®å°±ç»ªï¼ˆå¯è¯»å†™ Data ç«¯å£ï¼‰
- **ERR (bit 0)**ï¼š1 = ä¸Šæ¬¡æ“ä½œå‡ºé”™

> âš ï¸ **æ‰€æœ‰æ“ä½œå‰å¿…é¡»æ£€æŸ¥ BSY=0 ä¸” DRQ=1ï¼ˆè¯»æ—¶ï¼‰**ï¼

---

## âš™ï¸ ä¸‰ã€å®ç° IDE PIO è¯»æ‰‡åŒº

### æ­¥éª¤ï¼ˆREAD SECTOR å‘½ä»¤ï¼‰ï¼š
1. **ç­‰å¾…æ§åˆ¶å™¨ç©ºé—²**ï¼ˆBSY=0ï¼‰
2. **å†™å…¥å‚æ•°**ï¼šæ‰‡åŒºæ•°ã€LBA åœ°å€ã€é©±åŠ¨å™¨å·
3. **å‘é€ READ SECTOR å‘½ä»¤**ï¼ˆ0x20ï¼‰
4. **ç­‰å¾… DRQ=1**ï¼ˆæ•°æ®å°±ç»ªï¼‰
5. **ä» Data ç«¯å£è¯»å– 256 æ¬¡ï¼ˆæ¯æ¬¡ 2 å­—èŠ‚ï¼‰**ï¼Œå…± 512 å­—èŠ‚

### ä»£ç å®ç°ï¼š
```c
#define IDE_PRIMARY_IO 0x1F0
#define IDE_REG_STATUS(ide) (ide + 7)
#define IDE_REG_COMMAND(ide) (ide + 7)
#define IDE_REG_DATA(ide) (ide)

#define IDE_CMD_READ_SECTOR 0x20

// ä» IDE ç£ç›˜è¯»å–ä¸€ä¸ªæ‰‡åŒºï¼ˆ512 å­—èŠ‚ï¼‰
bool ide_read_sector(uint8_t drive, uint32_t lba, void *buffer) {
    uint16_t io_base = IDE_PRIMARY_IO;
    uint8_t status;

    // 1. ç­‰å¾…æ§åˆ¶å™¨ç©ºé—²
    do {
        status = inb(IDE_REG_STATUS(io_base));
    } while (status & (1 << 7)); // BSY

    // 2. è®¾ç½®å‚æ•°
    outb(IDE_REG_DATA(io_base) + 1, 0x00); // error
    outb(IDE_REG_DATA(io_base) + 2, 0x01); // æ‰‡åŒºæ•° = 1
    outb(IDE_REG_DATA(io_base) + 3, (lba >> 0) & 0xFF);  // LBA Low
    outb(IDE_REG_DATA(io_base) + 4, (lba >> 8) & 0xFF);  // LBA Mid
    outb(IDE_REG_DATA(io_base) + 5, (lba >> 16) & 0xFF); // LBA High
    outb(IDE_REG_DATA(io_base) + 6, 0xE0 | (drive << 4) | ((lba >> 24) & 0x0F));

    // 3. å‘é€å‘½ä»¤
    outb(IDE_REG_COMMAND(io_base), IDE_CMD_READ_SECTOR);

    // 4. ç­‰å¾…æ•°æ®å°±ç»ª
    do {
        status = inb(IDE_REG_STATUS(io_base));
        if (status & (1 << 0)) return false; // ERR
    } while (!(status & (1 << 3))); // ç­‰å¾… DRQ

    // 5. è¯»å–æ•°æ®ï¼ˆ256 æ¬¡ wordï¼‰
    uint16_t *buf = (uint16_t*)buffer;
    for (int i = 0; i < 256; i++) {
        buf[i] = inw(IDE_REG_DATA(io_base));
    }

    return true;
}
```

> ğŸ”‘ **`inb`/`outb`/`inw`**ï¼šå†…è”æ±‡ç¼–å®ç°çš„ç«¯å£ I/O æŒ‡ä»¤ã€‚

---

## ğŸ§± å››ã€å—è®¾å¤‡æŠ½è±¡å±‚

ä¸ºè®©æ–‡ä»¶ç³»ç»Ÿä¸ä¾èµ–å…·ä½“ç¡¬ä»¶ï¼Œæˆ‘ä»¬å®šä¹‰**å—è®¾å¤‡æ¥å£**ï¼š

```c
struct block_device {
    const char *name;
    uint64_t size; // æ€»æ‰‡åŒºæ•°
    int (*read_block)(struct block_device *bdev, uint64_t block, void *buffer);
    int (*write_block)(struct block_device *bdev, uint64_t block, const void *buffer);
    void *private_data; // æŒ‡å‘ ide_device
};

// IDE è®¾å¤‡æ³¨å†Œ
static struct block_device ide_bdev = {
    .name = "hda",
    .read_block = ide_bdev_read,
    .write_block = ide_bdev_write,
    .private_data = &ide_primary_master,
};
```

### æ–‡ä»¶ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿ
```c
// ext2_read_block ä¸­è°ƒç”¨
bdev->read_block(bdev, block_num, buffer);
```

> âœ… **ext2 æ— éœ€çŸ¥é“åº•å±‚æ˜¯ IDEã€AHCI è¿˜æ˜¯ SD å¡**ï¼

---

## ğŸ” äº”ã€ç£ç›˜æ¢æµ‹ä¸åˆå§‹åŒ–

### 1. **æ¢æµ‹ IDE æ§åˆ¶å™¨**
- æ£€æŸ¥ PCI è®¾å¤‡ï¼ˆè‹¥æ”¯æŒ PCIï¼‰ï¼Œæˆ–ç›´æ¥å‡è®¾ç«¯å£å­˜åœ¨
- å°è¯• IDENTIFY DEVICE å‘½ä»¤è·å–ç£ç›˜ä¿¡æ¯

### 2. **IDENTIFY DEVICE å‘½ä»¤**
```c
bool ide_identify(uint8_t drive, void *buffer) {
    // ç±»ä¼¼ read_sectorï¼Œä½†å‘½ä»¤ä¸º 0xEC
    // è¿”å› 512 å­—èŠ‚çš„ IDENTIFY æ•°æ®
    // åŒ…å«ï¼šç£ç›˜å‹å·ã€æ€»æ‰‡åŒºæ•°ã€æ˜¯å¦æ”¯æŒ LBA48 ç­‰
}
```

### 3. **åˆå§‹åŒ–å—è®¾å¤‡**
```c
void ide_init() {
    if (ide_identify(0, &identify_data)) {
        ide_bdev.size = *(uint64_t*)&identify_data[120]; // æ€»æ‰‡åŒºæ•°ï¼ˆLBA28ï¼‰
        block_device_register(&ide_bdev);
    }
}
```

---

## ğŸ§ª å…­ã€æ•´åˆï¼šä» IDE ç£ç›˜å¯åŠ¨ ext2

### å¯åŠ¨æµç¨‹ï¼š
1. **å†…æ ¸åˆå§‹åŒ–** â†’ `ide_init()`
2. **æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ**ï¼š
   ```c
   struct super_block *sb = ext2_mount(&ide_bdev);
   vfs_set_root(sb->s_root);
   ```
3. **æ‰§è¡Œ init è¿›ç¨‹**ï¼š
   ```c
   exec("/init", (char*[]){"init", NULL});
   ```

### QEMU æµ‹è¯•å‘½ä»¤ï¼š
```bash
# åˆ›å»ºç£ç›˜é•œåƒå¹¶å†™å…¥ ext2
dd if=/dev/zero of=disk.img bs=1M count=32
mkfs.ext2 -F disk.img
# æŒ‚è½½å¹¶å¤åˆ¶ init
sudo mount -o loop disk.img /mnt
sudo cp user_init /mnt/init
sudo umount /mnt

# å¯åŠ¨ï¼ˆQEMU æ¨¡æ‹Ÿ IDE ç£ç›˜ï¼‰
qemu-system-i386 -kernel kernel.bin -hda disk.img -serial stdio
```

è¿è¡Œæ•ˆæœï¼š
```
Welcome to MyOS!
# 
```

âœ… **ä½ çš„ OS ç°åœ¨é€šè¿‡è‡ªå·±çš„ IDE é©±åŠ¨ï¼Œä»ç£ç›˜åŠ è½½å¹¶è¿è¡Œäº† init ç¨‹åºï¼**

---

## âš ï¸ ä¸ƒã€å±€é™ä¸æœªæ¥æ–¹å‘

å½“å‰ IDE é©±åŠ¨ä»å¾ˆåŸºç¡€ï¼Œä½†ä¸ºåç»­æ‰“ä¸‹åŸºç¡€ï¼š

| é—®é¢˜ | æœªæ¥æ–¹æ¡ˆ |
|------|----------|
| **ä»… PIO æ¨¡å¼** | å®ç° DMA æå‡æ€§èƒ½ |
| **ä»…ä¸»é€šé“ä¸»ç›˜** | æ”¯æŒä»ç›˜ã€æ¬¡é€šé“ |
| **æ— ä¸­æ–­** | ä½¿ç”¨ä¸­æ–­é¿å…è½®è¯¢ï¼ˆæå‡ CPU æ•ˆç‡ï¼‰|
| **ä»… LBA28** | æ”¯æŒ LBA48ï¼ˆ>137GB ç£ç›˜ï¼‰|
| **æ— å†™æ”¯æŒ** | å®ç° WRITE SECTOR å‘½ä»¤ |

> ğŸŒ± **ä¸‹ä¸€æ­¥ï¼šå®ç° AHCI é©±åŠ¨ï¼ˆç°ä»£ SATA æ ‡å‡†ï¼‰**ï¼Œæˆ– **SD å¡é©±åŠ¨ï¼ˆæ ‘è“æ´¾ï¼‰**ï¼

---

## ğŸ’¬ å†™åœ¨æœ€å

å—è®¾å¤‡é©±åŠ¨æ˜¯æ“ä½œç³»ç»Ÿä¸ç‰©ç†ä¸–ç•Œçš„**ç¬¬ä¸€é“æ¡¥æ¢**ã€‚  
å®ƒæ¯ç‡¥ã€çç¢ï¼Œå……æ»¡ç¡¬ä»¶ç»†èŠ‚ï¼Œ  
ä½†æ­£æ˜¯è¿™äº›ä»£ç ï¼Œè®©â€œ0 å’Œ 1â€çœŸæ­£è½åˆ°äº†ç£ç›˜çš„ç£ç•´ä¸Šã€‚

ä»Šå¤©ä½ å†™çš„ `inb`/`outb`ï¼Œ  
æ­£æ˜¯ Linux å†…æ ¸ `drivers/ata/` ç›®å½•ä¸‹åƒè¡Œä»£ç çš„èµ·ç‚¹ã€‚

> ğŸŒŸ **æ²¡æœ‰é©±åŠ¨ï¼Œå†…æ ¸åªæ˜¯ç©ºä¸­æ¥¼é˜ï¼›æœ‰äº†é©±åŠ¨ï¼Œå®ƒæ‰è„šè¸å®åœ°ã€‚**

---

ğŸ“¬ **åŠ¨æ‰‹æŒ‘æˆ˜**ï¼š  
ä¿®æ”¹ IDE é©±åŠ¨ï¼Œæ”¯æŒè¯»å–ç¬¬äºŒä¸ªæ‰‡åŒºï¼ˆLBA=1ï¼‰ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶æ‰“å°å…¶å†…å®¹ã€‚  
æ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ç£ç›˜åå…­è¿›åˆ¶è½¬å‚¨ï¼

ğŸ‘‡ ä¸‹ä¸€ç¯‡ä½ æƒ³çœ‹ï¼š**AHCI (SATA) é©±åŠ¨**ï¼Œè¿˜æ˜¯ **SD å¡é©±åŠ¨ï¼ˆæ ‘è“æ´¾ï¼‰**ï¼Ÿ

---

**#æ“ä½œç³»ç»Ÿ #å†…æ ¸å¼€å‘ #å—è®¾å¤‡é©±åŠ¨ #IDE #ATA #ç¡¬ç›˜ #ç£ç›˜I/O #ä»é›¶å¼€å§‹**

---

> ğŸ“¢ **å½©è›‹**ï¼šå…³æ³¨åå›å¤å…³é”®è¯ **â€œideâ€**ï¼Œè·å–ï¼š
> - å®Œæ•´ IDE PIO é©±åŠ¨ä»£ç ï¼ˆå« inb/outb å®ç°ï¼‰
> - IDENTIFY DEVICE æ•°æ®ç»“æ„è§£æ
> - QEMU IDE è°ƒè¯•æŠ€å·§ï¼ˆå¯„å­˜å™¨ç›‘æ§ï¼‰
