# å­˜å‚¨ç³»ç»Ÿ-ext4 ç¯‡ï¼šä¸ºè‡ªåˆ¶ OS è®¾è®¡ç°ä»£æ–‡ä»¶ç³»ç»Ÿ

> **â€œext2 è™½ç»å…¸ï¼Œä½†é¢å¯¹å¤§æ–‡ä»¶ã€é«˜å¹¶å‘æ—¶åŠ›ä¸ä»å¿ƒã€‚  
> ext4 é€šè¿‡ Extentsã€å»¶è¿Ÿåˆ†é…ç­‰ç‰¹æ€§ï¼Œè§£å†³äº†ç¢ç‰‡ä¸æ€§èƒ½é—®é¢˜ã€‚  
> æœ¬æ–‡å°†è§£æ ext4 æ ¸å¿ƒæœºåˆ¶ï¼Œå¹¶å¯¹æ¯” XFS/Btrfs/ZFS çš„è®¾è®¡å“²å­¦ï¼Œ  
> ä¸ºè‡ªåˆ¶ OS æä¾›ç°ä»£æ–‡ä»¶ç³»ç»Ÿè®¾è®¡æ€è·¯ã€‚â€**

## å¼•è¨€ï¼šext2 çš„å±€é™ä¸ ext4 çš„æ¼”è¿›

ext2 ä½œä¸ºç»å…¸æ–‡ä»¶ç³»ç»Ÿï¼Œå­˜åœ¨æ˜æ˜¾å±€é™ï¼š
- **ç¢ç‰‡é—®é¢˜**ï¼šå°æ–‡ä»¶åˆ†æ•£å­˜å‚¨ï¼Œå¤§æ–‡ä»¶é—´æ¥å—éå†æ…¢
- **æ‰©å±•æ€§å·®**ï¼šæœ€å¤§ 2TB æ–‡ä»¶ï¼Œinode é™æ€åˆ†é…
- **æ— æ—¥å¿—**ï¼šæ–­ç”µæ˜“æŸåï¼Œfsck æ…¢
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šå—åˆ†é…æ— ä¼˜åŒ–ï¼Œå†™æ”¾å¤§ä¸¥é‡

**ext4**ï¼ˆFourth Extended Filesystemï¼‰ä½œä¸º ext2/ext3 çš„æ¼”è¿›ï¼Œ  
é€šè¿‡**å¢é‡æ”¹è¿›**è§£å†³äº†è¿™äº›é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒå…¼å®¹æ€§ï¼š
- **Extents**ï¼šæ›¿ä»£é—´æ¥å—ï¼Œé«˜æ•ˆç®¡ç†å¤§æ–‡ä»¶
- **å»¶è¿Ÿåˆ†é…**ï¼ˆDelayed Allocationï¼‰ï¼šå‡å°‘ç¢ç‰‡
- **å¤šå—åˆ†é…**ï¼ˆMultiblock Allocationï¼‰ï¼šæå‡å†™æ€§èƒ½
- **æ—¥å¿—æ ¡éªŒå’Œ**ï¼šæé«˜å¯é æ€§

æœ¬æ–‡å°†ä¸ºè‡ªåˆ¶ OS è®¾è®¡ä¸€ä¸ª**ç®€åŒ–ä½†ç°ä»£**çš„ ext4 é©±åŠ¨ï¼Œ  
å¹¶å¯¹æ¯”å…¶ä»–ç°ä»£æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡å“²å­¦ã€‚

---

## ç¬¬ä¸€ç« ï¼šext4 æ ¸å¿ƒç‰¹æ€§è§£æ

### 1.1 Extentsï¼šé«˜æ•ˆæ•°æ®å—ç®¡ç†

#### ext2 é—´æ¥å—çš„ç—›ç‚¹ï¼š
- **12 ç›´æ¥å— + 3 çº§é—´æ¥** â†’ å¤§æ–‡ä»¶éœ€å¤šæ¬¡ç£ç›˜ I/O
- **ç¢ç‰‡ä¸¥é‡**ï¼šæ–‡ä»¶å—åˆ†æ•£åœ¨ä¸åŒåŒºåŸŸ

#### Extents è®¾è®¡ï¼š
- **è¿ç»­å—èŒƒå›´**ï¼šç”¨ `(èµ·å§‹å—, é•¿åº¦)` æ›¿ä»£å•ä¸ªå—æŒ‡é’ˆ
- **Extent æ ‘**ï¼šæ”¯æŒå¤§æ–‡ä»¶é«˜æ•ˆå¯»å€

#### ext4 inode çš„ Extents ç»“æ„ï¼š
```c
// ext4.h
struct ext4_extent {
    uint32_t ee_block;    // é€»è¾‘å—å·ï¼ˆæ–‡ä»¶å†…åç§»ï¼‰
    uint16_t ee_len;      // å—æ•°
    uint16_t ee_start_hi; // ç‰©ç†å—é«˜ 16 ä½
    uint32_t ee_start_lo; // ç‰©ç†å—ä½ 32 ä½
} __attribute__((packed));

struct ext4_extent_header {
    uint16_t eh_magic;    // 0xF30A
    uint16_t eh_entries;  // å½“å‰é¡¹æ•°
    uint16_t eh_max;      // æœ€å¤§é¡¹æ•°
    uint16_t eh_depth;    // æ ‘æ·±åº¦ï¼ˆ0=å¶å­ï¼‰
    uint32_t eh_generation; // ç”Ÿæˆå·
} __attribute__((packed));

struct ext4_extent_idx {
    uint32_t ei_block;    // é€»è¾‘å—å·
    uint32_t ei_leaf_lo;  // å¶å­èŠ‚ç‚¹ä½ 32 ä½
    uint16_t ei_leaf_hi;  // å¶å­èŠ‚ç‚¹é«˜ 16 ä½
    uint16_t ei_unused;
} __attribute__((packed));

// inode ä¸­çš„ i_block å­—æ®µé‡ç”¨
struct ext4_inode {
    // ... å…¶ä»–å­—æ®µ
    union {
        struct ext4_extent_header h;
        struct ext4_extent extents[4]; // å¶å­èŠ‚ç‚¹
        struct ext4_extent_idx indexes[4]; // ç´¢å¼•èŠ‚ç‚¹
    } i_block[15];
};
```

#### Extents å¯»å€æµç¨‹ï¼š
1. **å°æ–‡ä»¶**ï¼ˆâ‰¤4 ä¸ª extentï¼‰ï¼šç›´æ¥å­˜å‚¨åœ¨ inode
2. **å¤§æ–‡ä»¶**ï¼šinode å­˜ç´¢å¼•èŠ‚ç‚¹ â†’ å¶å­èŠ‚ç‚¹å­˜ extent
3. **æŸ¥æ‰¾**ï¼šäºŒåˆ†æœç´¢ extent æ•°ç»„

### 1.2 å»¶è¿Ÿåˆ†é…ï¼ˆDelayed Allocationï¼‰

#### é—®é¢˜ï¼š
- **ext2 ç«‹å³åˆ†é…**ï¼šå†™å…¥æ—¶ç«‹å³åˆ†é…å— â†’ ç¢ç‰‡
- **å°æ–‡ä»¶å†™æ”¾å¤§**ï¼šæ¯æ¬¡å†™éƒ½åˆ†é…æ–°å—

#### è§£å†³æ–¹æ¡ˆï¼š
- **å†™å…¥æ—¶ä»…ç¼“å­˜æ•°æ®**ï¼Œä¸åˆ†é…ç£ç›˜å—
- **æ–‡ä»¶å…³é—­/åŒæ­¥æ—¶**ï¼Œæ‰åˆ†é…è¿ç»­å—

#### ä¼˜åŠ¿ï¼š
- **å‡å°‘ç¢ç‰‡**ï¼šå¤§å—è¿ç»­åˆ†é…
- **å‡å°‘å…ƒæ•°æ®å†™**ï¼šå¤šä¸ªå†™åˆå¹¶ä¸ºä¸€æ¬¡åˆ†é…
- **æå‡æ€§èƒ½**ï¼šé¿å…å°æ–‡ä»¶å†™æ”¾å¤§

### 1.3 å¤šå—åˆ†é…ï¼ˆMultiblock Allocationï¼‰

#### é—®é¢˜ï¼š
- **ext2 å•å—åˆ†é…**ï¼šæ¯æ¬¡åˆ†é…ä¸€ä¸ªå—
- **ç£å¤´ç§»åŠ¨å¤š**ï¼šå—åˆ†æ•£å¯¼è‡´æ€§èƒ½ä¸‹é™

#### è§£å†³æ–¹æ¡ˆï¼š
- **é¢„åˆ†é…è¿ç»­å—**ï¼šä¸€æ¬¡åˆ†é…å¤šä¸ªå—
- **å—åˆ†é…å™¨ä¼˜åŒ–**ï¼šå¯»æ‰¾æœ€å¤§è¿ç»­ç©ºé—²åŒºåŸŸ

#### å®ç°ï¼š
```c
// ext4.cï¼ˆç®€åŒ–ï¼‰
static uint32_t ext4_new_blocks(struct ext4_sb_info *sb, 
                                uint32_t goal, 
                                int count) {
    // 1. ä» goal é™„è¿‘æŸ¥æ‰¾è¿ç»­ count ä¸ªç©ºé—²å—
    // 2. æ›´æ–°å—ä½å›¾å’Œç»„æè¿°ç¬¦
    // 3. è¿”å›èµ·å§‹å—å·
    return start_block;
}
```

---

## ç¬¬äºŒç« ï¼šext4 ç£ç›˜å¸ƒå±€æ”¹è¿›

### 2.1 çµæ´»çš„ inode å¤§å°

#### ext2 é™åˆ¶ï¼š
- **å›ºå®š 128 å­—èŠ‚ inode**ï¼šæ— æ³•æ‰©å±•

#### ext4 æ”¹è¿›ï¼š
- **å¯å˜ inode å¤§å°**ï¼ˆ128-4096 å­—èŠ‚ï¼‰
- **æ‰©å±•å±æ€§**ï¼ˆxattrï¼‰ï¼šå­˜å‚¨é¢å¤–å…ƒæ•°æ®

```c
// è¶…çº§å—å­—æ®µ
uint16_t s_inode_size;    // inode å¤§å°
uint16_t s_first_ino;     // ç¬¬ä¸€ä¸ªéä¿ç•™ inode
```

### 2.2 åŒºï¼ˆBlock Groupï¼‰æ”¹è¿›

#### flex_bg ç‰¹æ€§ï¼š
- **å¤šä¸ªå—ç»„ç»„æˆ flex_bg**
- **å…ƒæ•°æ®é›†ä¸­å­˜å‚¨**ï¼šè¶…çº§å—ã€GDT åœ¨ flex_bg å¼€å¤´
- **æå‡å¤§æ–‡ä»¶æ€§èƒ½**ï¼šæ•°æ®å—è¿ç»­åˆ†é…

#### æ— åº inode åˆ†é…ï¼š
- **inode åˆ†é…ä¸ä¸¥æ ¼æŒ‰ç»„**ï¼šå‡å°‘çƒ­ç‚¹

### 2.3 æ ¡éªŒå’Œä¸å…ƒæ•°æ®ä¿æŠ¤

#### å…ƒæ•°æ®æ ¡éªŒå’Œï¼š
- **è¶…çº§å—ã€GDTã€inode è¡¨** æ·»åŠ  CRC32 æ ¡éªŒ
- **æå‰æ£€æµ‹æŸå**ï¼šé¿å…é™é»˜æ•°æ®æŸå

```c
// è¶…çº§å—æ‰©å±•å­—æ®µ
uint32_t s_checksum;      // è¶…çº§å—æ ¡éªŒå’Œ
uint32_t s_checksum_type; // æ ¡éªŒç±»å‹
```

---

## ç¬¬ä¸‰ç« ï¼šæ—¥å¿—ï¼ˆJournalingï¼‰æœºåˆ¶

### 3.1 æ—¥å¿—åŸºç¡€

#### æ—¥å¿—ç»“æ„ï¼š
```
+-----------------+
|  Journal Superblock |
+-----------------+
|  Descriptor Block   | â† æè¿°è¦å†™å…¥çš„å—
+-----------------+
|  Data Blocks        | â† å®é™…æ•°æ®ï¼ˆå¯é€‰ï¼‰
+-----------------+
|  Commit Block       | â† æäº¤æ ‡è®°
+-----------------+
```

#### æ—¥å¿—å·¥ä½œæµç¨‹ï¼š
1. **å¼€å§‹äº‹åŠ¡**ï¼šå†™å…¥ descriptor
2. **å†™å…¥æ•°æ®**ï¼šåˆ°æ—¥å¿—æˆ–ç›´æ¥åˆ°æ–‡ä»¶ç³»ç»Ÿ
3. **æäº¤äº‹åŠ¡**ï¼šå†™å…¥ commit å—
4. **æ£€æŸ¥ç‚¹**ï¼šåå°å°†æ—¥å¿—æ•°æ®å†™å…¥æ–‡ä»¶ç³»ç»Ÿ

### 3.2 ä¸‰ç§æ—¥å¿—æ¨¡å¼

| æ¨¡å¼ | å…ƒæ•°æ® | æ•°æ® | å®‰å…¨æ€§ | æ€§èƒ½ |
|------|--------|------|--------|------|
| **journal** | æ—¥å¿— | æ—¥å¿— | æœ€é«˜ | æœ€æ…¢ |
| **ordered** | æ—¥å¿— | å…ˆæ–‡ä»¶ç³»ç»Ÿåæ—¥å¿— | é«˜ï¼ˆé»˜è®¤ï¼‰ | ä¸­ |
| **writeback** | æ—¥å¿— | æ— é¡ºåº | ä½ | æœ€å¿« |

#### ordered æ¨¡å¼ï¼ˆæ¨èï¼‰ï¼š
- **æ•°æ®å…ˆå†™å…¥æ–‡ä»¶ç³»ç»Ÿ**
- **å…ƒæ•°æ®å†™å…¥æ—¥å¿—å¹¶æäº¤**
- **ä¿è¯æ•°æ®ä¸€è‡´æ€§**ï¼šé¿å…å…ƒæ•°æ®æŒ‡å‘æœªå†™å…¥æ•°æ®

### 3.3 æ—¥å¿—å®ç°è¦ç‚¹

#### äº‹åŠ¡ç®¡ç†ï¼š
```c
// journal.h
struct journal_handle {
    int h_transaction_id;
    int h_buffer_credits; // ç¼“å†²åŒºé…é¢
};

struct journal_handle *journal_start(struct journal *journal, int nblocks);
int journal_stop(struct journal_handle *handle);
```

#### æ—¥å¿—å†™å…¥ï¼š
```c
// journal.c
static int journal_write_metadata(struct journal_handle *handle, 
                                 struct buffer_head *bh) {
    // 1. å°† buffer_head åŠ å…¥äº‹åŠ¡
    // 2. å†™å…¥æ—¥å¿—æè¿°ç¬¦
    // 3. å†™å…¥æ•°æ®å—ï¼ˆjournal æ¨¡å¼ï¼‰
    return 0;
}
```

---

## ç¬¬å››ç« ï¼šext4 ä¸ VFS é›†æˆ

### 4.1 Extents å¯»å€å®ç°

```c
// ext4.c
static uint32_t ext4_find_block(struct ext4_inode *inode, uint32_t block) {
    struct ext4_extent_header *eh = (void*)inode->i_block;
    
    if (eh->eh_depth == 0) {
        // å¶å­èŠ‚ç‚¹ï¼šäºŒåˆ†æœç´¢
        struct ext4_extent *extents = (void*)(eh + 1);
        for (int i = 0; i < eh->eh_entries; i++) {
            if (block >= extents[i].ee_block && 
                block < extents[i].ee_block + extents[i].ee_len) {
                return extents[i].ee_start_lo + (block - extents[i].ee_block);
            }
        }
    } else {
        // ç´¢å¼•èŠ‚ç‚¹ï¼šé€’å½’æŸ¥æ‰¾
        struct ext4_extent_idx *indexes = (void*)(eh + 1);
        // ... ç±»ä¼¼å®ç°
    }
    return 0;
}
```

### 4.2 å»¶è¿Ÿåˆ†é…å†™å…¥

```c
// ext4_file.c
static ssize_t ext4_file_write(struct vfs_file *file, 
                              const char *buf, 
                              size_t count) {
    // 1. å°†æ•°æ®å†™å…¥ page cacheï¼ˆä¸åˆ†é…ç£ç›˜å—ï¼‰
    // 2. æ ‡è®°é¡µä¸º dirty
    // 3. è¿”å›ï¼ˆå®é™…åˆ†é…åœ¨ fsync/close æ—¶ï¼‰
    return count;
}

static int ext4_file_fsync(struct vfs_file *file) {
    // 1. ä¸º dirty é¡µåˆ†é…ç£ç›˜å—ï¼ˆå»¶è¿Ÿåˆ†é…ï¼‰
    // 2. æ›´æ–° inode
    // 3. æäº¤æ—¥å¿—äº‹åŠ¡
    return 0;
}
```

---

## ç¬¬äº”ç« ï¼šç°ä»£æ–‡ä»¶ç³»ç»Ÿè®¾è®¡å“²å­¦å¯¹æ¯”

### 5.1 XFSï¼šé«˜æ€§èƒ½æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ

#### æ ¸å¿ƒæ€æƒ³ï¼š
- **åˆ†é…ç»„**ï¼ˆAllocation Groupï¼‰ï¼šå¹¶è¡Œåˆ†é…
- **B+ æ ‘**ï¼šé«˜æ•ˆç®¡ç† inode å’Œ extent
- **æ—¥å¿—ä¼˜åŒ–**ï¼šå¼‚æ­¥æäº¤ï¼Œé«˜åå

#### é€‚ç”¨åœºæ™¯ï¼š
- **å¤§æ–‡ä»¶**ï¼šåª’ä½“ã€æ•°æ®åº“
- **é«˜å¹¶å‘**ï¼šå¤šçº¿ç¨‹å†™å…¥

### 5.2 Btrfsï¼šå†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰æ–‡ä»¶ç³»ç»Ÿ

#### æ ¸å¿ƒæ€æƒ³ï¼š
- **CoW**ï¼šä¿®æ”¹æ—¶å¤åˆ¶ï¼Œä¿è¯ä¸€è‡´æ€§
- **å­å·**ï¼ˆSubvolumeï¼‰ï¼šå¿«ç…§ã€å…‹éš†
- **RAID é›†æˆ**ï¼šå†…ç½® RAID 0/1/10

#### ä¼˜åŠ¿ï¼š
- **å¿«ç…§**ï¼šç§’çº§åˆ›å»º
- **æ•°æ®æ ¡éªŒ**ï¼šchecksum é˜²é™é»˜æŸå
- **åœ¨çº¿ç¢ç‰‡æ•´ç†**

#### æŒ‘æˆ˜ï¼š
- **å¤æ‚åº¦é«˜**ï¼šCoW å¯¼è‡´å†™æ”¾å¤§
- **ç¢ç‰‡é—®é¢˜**ï¼šé•¿æœŸè¿è¡Œåæ€§èƒ½ä¸‹é™

### 5.3 ZFSï¼šç»ˆæä¼ä¸šçº§æ–‡ä»¶ç³»ç»Ÿ

#### æ ¸å¿ƒæ€æƒ³ï¼š
- **æ± åŒ–å­˜å‚¨**ï¼ˆZPoolï¼‰ï¼šæ•´åˆå¤šè®¾å¤‡
- **ç«¯åˆ°ç«¯æ ¡éªŒ**ï¼šä»åº”ç”¨åˆ°ç£ç›˜
- **ARC ç¼“å­˜**ï¼šè‡ªé€‚åº”æ›¿æ¢ç¼“å­˜

#### ä¼˜åŠ¿ï¼š
- **æ•°æ®å®Œæ•´æ€§**ï¼šchecksum + è‡ªæ„ˆ
- **å¿«ç…§/å…‹éš†**ï¼šé«˜æ•ˆ CoW
- **å‹ç¼©/å»é‡**ï¼šèŠ‚çœç©ºé—´

#### æŒ‘æˆ˜ï¼š
- **å†…å­˜éœ€æ±‚é«˜**ï¼šARC éœ€å¤§é‡ RAM
- **è®¸å¯è¯é—®é¢˜**ï¼šCDDL ä¸ GPL ä¸å…¼å®¹

### 5.4 å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | ext4 | XFS | Btrfs | ZFS |
|------|------|-----|-------|-----|
| **æ—¥å¿—** | æ˜¯ | æ˜¯ | CoW | CoW |
| **å¿«ç…§** | å¦ | æœ‰ï¼ˆLVMï¼‰ | åŸç”Ÿ | åŸç”Ÿ |
| **æ ¡éªŒå’Œ** | å…ƒæ•°æ® | å¦ | æ˜¯ | æ˜¯ |
| **RAID** | å¤–éƒ¨ | å¤–éƒ¨ | å†…ç½® | å†…ç½® |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨ | å¤§æ–‡ä»¶ | æ¡Œé¢/æœåŠ¡å™¨ | ä¼ä¸šå­˜å‚¨ |

> ğŸ’¡ **è‡ªåˆ¶ OS å»ºè®®**ï¼šä» ext4 å¼€å§‹ï¼Œé€æ­¥å¼•å…¥ CoWã€æ ¡éªŒå’Œç­‰ç‰¹æ€§

---

## ç¬¬å…­ç« ï¼šFUSEï¼šç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿæ¡†æ¶

### 6.1 FUSE æ ¸å¿ƒæ€æƒ³

#### é—®é¢˜ï¼š
- **å†…æ ¸æ–‡ä»¶ç³»ç»Ÿå¼€å‘å¤æ‚**ï¼šéœ€å¤„ç† VFSã€ç¼“å­˜ã€é”
- **è°ƒè¯•å›°éš¾**ï¼šå†…æ ¸å´©æºƒéš¾è°ƒè¯•

#### è§£å†³æ–¹æ¡ˆï¼š
- **ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ**ï¼šé€šè¿‡ FUSE å†…æ ¸æ¨¡å—ä¸ VFS äº¤äº’
- **æ ‡å‡† API**ï¼šå®ç° open/read/write ç­‰å›è°ƒ

#### æ¶æ„ï¼š
```
+------------------+
|   ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ  |  // å®ç° FUSE API
+------------------+
|   libfuse        |  // ç”¨æˆ·åº“
+------------------+
|   fuse.ko        |  // å†…æ ¸æ¨¡å—ï¼ˆVFS é€‚é…ï¼‰
+------------------+
|       VFS        |
+------------------+
```

### 6.2 FUSE for è‡ªåˆ¶ OS

#### å†…æ ¸ FUSE æ¨¡å—ï¼š
```c
// fuse_vfs.c
static ssize_t fuse_read(struct vfs_file *file, char *buf, size_t count) {
    // 1. æ„é€  FUSE è¯»è¯·æ±‚
    struct fuse_read_in in = {
        .fh = file->f_private,
        .offset = file->f_pos,
        .size = count,
    };
    
    // 2. å‘é€è¯·æ±‚åˆ°ç”¨æˆ·æ€
    struct fuse_out_header out;
    fuse_send_request(FUSE_READ, &in, sizeof(in), buf, count, &out);
    
    return out.len;
}
```

#### ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿç¤ºä¾‹ï¼š
```c
// user/myfs.c
static int myfs_read(const char *path, char *buf, size_t size, 
                     off_t offset, struct fuse_file_info *fi) {
    // 1. æŸ¥æ‰¾æ–‡ä»¶
    // 2. ä»å†…å­˜/ç½‘ç»œè¯»å–æ•°æ®
    // 3. å¤åˆ¶åˆ° buf
    return actual_size;
}

static struct fuse_operations myfs_ops = {
    .read = myfs_read,
    .write = myfs_write,
    // ...
};

int main() {
    return fuse_main(0, NULL, &myfs_ops, NULL);
}
```

#### ä¼˜åŠ¿ï¼š
- **å¿«é€Ÿå¼€å‘**ï¼šç”¨ C/Python å®ç°æ–‡ä»¶ç³»ç»Ÿ
- **å®‰å…¨éš”ç¦»**ï¼šç”¨æˆ·æ€å´©æºƒä¸å½±å“å†…æ ¸
- **çµæ´»æ‰©å±•**ï¼šæ”¯æŒç½‘ç»œæ–‡ä»¶ç³»ç»Ÿã€åŠ å¯†ç­‰

---

## ç»“è®ºï¼šç°ä»£æ–‡ä»¶ç³»ç»Ÿçš„æ¼”è¿›ä¹‹è·¯

ext4 ä»£è¡¨äº†**æ¸è¿›å¼æ”¹è¿›**çš„æˆåŠŸï¼š  
åœ¨ä¿æŒ ext2 å…¼å®¹æ€§çš„åŒæ—¶ï¼Œ  
é€šè¿‡ Extentsã€å»¶è¿Ÿåˆ†é…ç­‰ç‰¹æ€§ï¼Œ  
è§£å†³äº†ç¢ç‰‡ä¸æ€§èƒ½é—®é¢˜ã€‚

è€Œ XFSã€Btrfsã€ZFS å±•ç°äº†**ä¸åŒè®¾è®¡å“²å­¦**ï¼š
- **XFS**ï¼šæè‡´æ€§èƒ½
- **Btrfs**ï¼šCoW ä¸å¿«ç…§
- **ZFS**ï¼šæ•°æ®å®Œæ•´æ€§

å¯¹äºè‡ªåˆ¶ OSï¼Œå»ºè®®ï¼š
1. **ä» ext4 å¼€å§‹**ï¼šå®ç° Extents å’Œå»¶è¿Ÿåˆ†é…
2. **é€æ­¥å¼•å…¥ç‰¹æ€§**ï¼šæ—¥å¿—ã€æ ¡éªŒå’Œ
3. **æ¢ç´¢ FUSE**ï¼šå¿«é€Ÿå®ç°ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ

çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå§‹äºå¯¹æ•°æ®å¸ƒå±€çš„æ·±åˆ»ç†è§£ï¼Œ  
æˆäºå¯¹æ€§èƒ½ä¸å¯é æ€§çš„å¹³è¡¡ã€‚

---

## é™„å½•ï¼šext4 å…³é”®å¸¸é‡

### ext4 ç‰¹æ€§æ ‡å¿—
```c
#define EXT4_FEATURE_COMPAT_EXTENTS 0x0040
#define EXT4_FEATURE_COMPAT_FLEX_BG 0x0200
#define EXT4_FEATURE_RO_COMPAT_METADATA_CSUM 0x4000
#define EXT4_FEATURE_INCOMPAT_EXTENTS 0x0040
#define EXT4_FEATURE_INCOMPAT_FLEX_BG 0x0200
```

### æ—¥å¿—å¸¸é‡
```c
#define JFS_MAGIC 0xC03B3998
#define JFS_DESCRIPTOR_BLOCK 1
#define JFS_COMMIT_BLOCK 2
```

### å®ç”¨å·¥å…·
- **mkfs.ext4**ï¼šåˆ›å»º ext4 é•œåƒ
  ```bash
  mkfs.ext4 -F disk.img
  ```
- **tune2fs**ï¼šè°ƒæ•´ ext4 å‚æ•°
  ```bash
  tune2fs -O extents disk.img  # å¯ç”¨ extents
  ```

> **æ³¨**ï¼šæœ¬æ–‡æ‰€æœ‰ä»£ç å‡ä¸ºç®€åŒ–å®ç°ï¼Œå®é™…ä½¿ç”¨éœ€æ·»åŠ é”™è¯¯å¤„ç†ã€ç¼“å­˜ã€å¹¶å‘æ§åˆ¶ç­‰ã€‚