# ä»Žé›¶å†™ OS å†…æ ¸-ç¬¬å››ç¯‡ï¼šè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼ˆæ®µå¼å†…å­˜ç®¡ç†è¯¦è§£ï¼‰

> **â€œä¿æŠ¤æ¨¡å¼ â‰  åˆ†é¡µï¼  
> å®ƒçš„ç¬¬ä¸€é“é˜²çº¿ï¼Œæ˜¯è¢«çŽ°ä»£ OS â€˜æ‚„æ‚„ç»•è¿‡â€™çš„æ®µæœºåˆ¶ã€‚â€**

åœ¨å‰é¢å‡ ç¯‡ä¸­ï¼Œæˆ‘ä»¬å€ŸåŠ© GRUB è½»æ¾å¯åŠ¨äº†å†…æ ¸ï¼Œè¾“å‡ºäº† â€œHello Worldâ€ï¼Œè¿˜ç†è§£äº† Multiboot åè®®ã€‚  
ä½†ä½ æ˜¯å¦æƒ³è¿‡ï¼š**ä¸ºä»€ä¹ˆ GRUB è¦å¸®æˆ‘ä»¬è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Ÿå®ƒåˆ°åº•åœ¨ä¿æŠ¤ä»€ä¹ˆï¼Ÿ**

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥äº²æ‰‹å®Œæˆè¿™ä¸€åŽ†å²æ€§è½¬å˜â€”â€”**ä»Žå®žæ¨¡å¼ï¼ˆReal Modeï¼‰åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼ï¼ˆProtected Modeï¼‰**ï¼Œå¹¶æ·±å…¥ç†è§£å…¶æ ¸å¿ƒï¼š**æ®µå¼å†…å­˜ç®¡ç†ï¼ˆSegmentationï¼‰**ï¼ŒåŒ…æ‹¬ GDTã€LDT ä¸Žæ®µé€‰æ‹©å­çš„å·¥ä½œåŽŸç†ã€‚

> ðŸ”¥ å³ä¾¿çŽ°ä»£æ“ä½œç³»ç»Ÿå‡ ä¹Žâ€œåºŸå¼ƒâ€äº†æ®µæœºåˆ¶ï¼Œ**ç†è§£å®ƒï¼Œä»æ˜¯æŽŒæ¡ x86 æž¶æž„çš„å¿…ç»ä¹‹è·¯**ã€‚

---

## ä¸€ã€ä»€ä¹ˆæ˜¯å®žæ¨¡å¼ï¼ˆReal Modeï¼‰ï¼Ÿ

**å®žæ¨¡å¼**ï¼Œæ˜¯ x86 CPU ä¸Šç”µåŽçš„**é»˜è®¤è¿è¡ŒçŠ¶æ€**ï¼Œæºè‡ª 1978 å¹´çš„ **Intel 8086** å¤„ç†å™¨ã€‚

### âœ… ç‰¹ç‚¹ï¼š
- **20 ä½åœ°å€çº¿** â†’ æœ€å¤§å¯»å€ **1MB å†…å­˜**ï¼ˆ0x00000 ~ 0xFFFFFï¼‰
- **æ®µ:åç§»å¯»å€**ï¼šç‰©ç†åœ°å€ = æ®µå¯„å­˜å™¨ Ã— 16 + åç§»  
  ä¾‹å¦‚ï¼š`CS:IP = 0x1000:0x0020` â†’ ç‰©ç†åœ°å€ = `0x10000 + 0x20 = 0x10020`
- **æ— å†…å­˜ä¿æŠ¤**ï¼šä»»ä½•ç¨‹åºå¯è¯»å†™ä»»æ„å†…å­˜ï¼ˆåŒ…æ‹¬ BIOS å’Œæ˜¾å­˜ï¼‰
- **æ— ç‰¹æƒçº§**ï¼šæ‰€æœ‰ä»£ç è¿è¡Œåœ¨â€œä¸Šå¸æ¨¡å¼â€

> ðŸ’¡ å®žæ¨¡å¼å°±åƒä¸€è¾†æ²¡æœ‰æ–¹å‘ç›˜ã€æ²¡æœ‰åˆ¹è½¦çš„è€å¼æ‹–æ‹‰æœºâ€”â€”ç®€å•ï¼Œä½†æžå…¶å±é™©ã€‚

### â“ ä¸ºä»€ä¹ˆçŽ°ä»£ CPU è¿˜è¦ä»Žå®žæ¨¡å¼å¯åŠ¨ï¼Ÿ
**ä¸ºäº†å…¼å®¹ï¼**  
PC å…¼å®¹æœºå¿…é¡»èƒ½è¿è¡Œ 1980 å¹´ä»£çš„è€ DOS ç¨‹åºï¼Œæ‰€ä»¥ CPU ä¸Šç”µåŽâ€œå‡è£…è‡ªå·±æ˜¯ 8086â€ã€‚

---

## äºŒã€ä»€ä¹ˆæ˜¯ä¿æŠ¤æ¨¡å¼ï¼ˆProtected Modeï¼‰ï¼Ÿ

**ä¿æŠ¤æ¨¡å¼**ç”± **Intel 80286**ï¼ˆ1982ï¼‰å¼•å…¥ï¼Œ80386 èµ·æˆä¸ºçŽ°ä»£æ“ä½œç³»ç»Ÿçš„åŸºçŸ³ã€‚

### âœ… æ ¸å¿ƒä¼˜åŠ¿ï¼š

| ç‰¹æ€§ | è¯´æ˜Ž |
|------|------|
| **32 ä½å¯»å€** | å¯è®¿é—® **4GB å†…å­˜**ï¼ˆåŽç»­é€šè¿‡ PAE/64 ä½æ‰©å±•ï¼‰|
| **å†…å­˜ä¿æŠ¤** | é˜²æ­¢ç¨‹åºè¶Šç•Œè®¿é—®ï¼ˆæ®µç•Œé™ã€æƒé™æ£€æŸ¥ï¼‰|
| **ç‰¹æƒçº§ï¼ˆRing 0~3ï¼‰** | å†…æ ¸ï¼ˆRing 0ï¼‰ vs ç”¨æˆ·ç¨‹åºï¼ˆRing 3ï¼‰|
| **è™šæ‹Ÿå†…å­˜åŸºç¡€** | ä¸ºåˆ†é¡µï¼ˆPagingï¼‰æä¾›æ”¯æŒ |

> ðŸŒŸ ä¿æŠ¤æ¨¡å¼ä¸‹çš„å†…å­˜è®¿é—®ï¼Œä¸å†æ˜¯â€œç›´æŽ¥ç‰©ç†åœ°å€â€ï¼Œè€Œæ˜¯é€šè¿‡ **æ®µæè¿°ç¬¦è¡¨** è¿›è¡Œç¿»è¯‘å’Œæ ¡éªŒã€‚

---

## ä¸‰ã€å…³é”®æœºåˆ¶ï¼šæ®µæè¿°ç¬¦ä¸Žæ®µå¯„å­˜å™¨

åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œæ®µå¯„å­˜å™¨ï¼ˆCSã€DSã€SS ç­‰ï¼‰**ä¸å†ç›´æŽ¥å­˜åœ°å€**ï¼Œè€Œæ˜¯å­˜ä¸€ä¸ª **æ®µé€‰æ‹©å­ï¼ˆSegment Selectorï¼‰**ã€‚

### ðŸ” æ®µé€‰æ‹©å­ç»“æž„ï¼ˆ16 ä½ï¼‰ï¼š
```
| 15        3 | 2 | 1 | 0 |
|   Index     | TI| RPL|
```
- **Index**ï¼šåœ¨ GDT/LDT è¡¨ä¸­çš„ç´¢å¼•ï¼ˆÃ—8 å¾—åˆ°å­—èŠ‚åç§»ï¼‰
- **TI**ï¼ˆTable Indicatorï¼‰ï¼š0 = GDTï¼Œ1 = LDT
- **RPL**ï¼ˆRequested Privilege Levelï¼‰ï¼šè¯·æ±‚ç‰¹æƒçº§ï¼ˆ0~3ï¼‰

### ðŸ“¦ æ®µæè¿°ç¬¦ï¼ˆ64 ä½ï¼‰
ç”± Index æŒ‡å‘çš„æè¿°ç¬¦ï¼ŒåŒ…å«ï¼š
- æ®µåŸºåœ°å€ï¼ˆ32 ä½ï¼‰
- æ®µç•Œé™ï¼ˆLimitï¼‰
- ç±»åž‹ï¼ˆä»£ç /æ•°æ®/åªè¯»/å¯æ‰§è¡Œç­‰ï¼‰
- DPLï¼ˆDescriptor Privilege Levelï¼‰
- G ä½ï¼ˆç²’åº¦ï¼š0=å­—èŠ‚ï¼Œ1=4KBï¼‰

> âœ… CPU é€šè¿‡ **GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰** æˆ– **LDTï¼ˆå±€éƒ¨æè¿°ç¬¦è¡¨ï¼‰** æŸ¥æ‰¾æè¿°ç¬¦ã€‚

---

## å››ã€GDT vs LDTï¼šè°æ¥ç®¡ç†â€œæ®µâ€ï¼Ÿ

| å¯¹æ¯”é¡¹ | GDTï¼ˆGlobal Descriptor Tableï¼‰ | LDTï¼ˆLocal Descriptor Tableï¼‰ |
|--------|-------------------------------|------------------------------|
| **ä½œç”¨èŒƒå›´** | å…¨å±€ï¼Œæ‰€æœ‰ä»»åŠ¡å…±äº« | å±€éƒ¨ï¼Œæ¯ä¸ªä»»åŠ¡å¯æœ‰è‡ªå·±çš„ LDT |
| **æ•°é‡** | ç³»ç»Ÿåªæœ‰ä¸€ä¸ª | å¯æœ‰å¤šä¸ªï¼ˆæ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªï¼‰ |
| **ä½¿ç”¨é¢‘çŽ‡** | **æžé«˜**ï¼ˆå†…æ ¸ã€ç”¨æˆ·ä»£ç /æ•°æ®æ®µï¼‰ | æžä½Žï¼ˆçŽ°ä»£ OS å‡ ä¹Žä¸ç”¨ï¼‰ |
| **åˆ‡æ¢æ–¹å¼** | `LGDT` æŒ‡ä»¤åŠ è½½ | é€šè¿‡ GDT ä¸­çš„ä¸€ä¸ªç‰¹æ®Šæè¿°ç¬¦æŒ‡å‘ LDT |

> ðŸ“Œ **çŽ°ä»£æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxï¼‰å‡ ä¹Žå®Œå…¨å¼ƒç”¨ LDT**ï¼Œè½¬è€Œä¾èµ–**åˆ†é¡µæœºåˆ¶**å®žçŽ°å†…å­˜éš”ç¦»ã€‚  
> ä½†åœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼åˆæœŸï¼Œ**GDT æ˜¯å¿…é¡»çš„**ï¼

---

## äº”ã€å®žæˆ˜ï¼šå¦‚ä½•ä»Žå®žæ¨¡å¼è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Ÿ

å³ä½¿ä½ ç”¨ GRUB å¯åŠ¨ï¼ˆå®ƒå·²åˆ‡æ¢ï¼‰ï¼Œ**æ‰‹åŠ¨å®žçŽ°ä¸€æ¬¡ï¼Œæ‰èƒ½çœŸæ­£ç†è§£**ã€‚  
ä»¥ä¸‹æ˜¯è£¸æœºçŽ¯å¢ƒä¸‹åˆ‡æ¢çš„å®Œæ•´æ­¥éª¤ï¼š

### æ­¥éª¤ 1ï¼šå…³é—­ä¸­æ–­
```nasm
cli    ; ç¦ç”¨å¯å±è”½ä¸­æ–­
```

### æ­¥éª¤ 2ï¼šåŠ è½½ GDT
å…ˆå®šä¹‰ GDTï¼ˆé€šå¸¸åœ¨æ±‡ç¼–ä¸­ï¼‰ï¼š
```nasm
gdt_start:
    dq 0x0                    ; ç©ºæè¿°ç¬¦ï¼ˆå¿…é¡»ï¼‰

gdt_code:
    dw 0xFFFF                 ; æ®µç•Œé™ 0-15
    dw 0x0                    ; åŸºåœ°å€ 0-15
    db 0x0                    ; åŸºåœ°å€ 16-23
    db 10011010b              ; ç±»åž‹ï¼šä»£ç æ®µï¼Œå¯è¯»ï¼ŒDPL=0
    db 11001111b              ; ç²’åº¦ï¼š4KBï¼Œ32ä½
    db 0x0                    ; åŸºåœ°å€ 24-31

gdt_data:
    dw 0xFFFF
    dw 0x0
    db 0x0
    db 10010010b              ; æ•°æ®æ®µï¼Œå¯å†™ï¼ŒDPL=0
    db 11001111b
    db 0x0

gdt_end:

gdt_descriptor:
    dw gdt_end - gdt_start - 1   ; GDT å¤§å°
    dd gdt_start                 ; GDT èµ·å§‹åœ°å€
```

åŠ è½½ GDTï¼š
```nasm
lgdt [gdt_descriptor]
```

### æ­¥éª¤ 3ï¼šè®¾ç½® CR0 çš„ PE ä½ï¼ˆProtection Enableï¼‰
```nasm
mov eax, cr0
or eax, 0x1      ; è®¾ç½® bit 0 (PE)
mov cr0, eax
```

### æ­¥éª¤ 4ï¼šè¿œè·³è½¬ï¼Œåˆ·æ–° CS æ®µå¯„å­˜å™¨
```nasm
jmp 0x08:protected_mode_start   ; 0x08 = GDT ä¸­ä»£ç æ®µé€‰æ‹©å­ï¼ˆIndex=1, TI=0, RPL=0ï¼‰
```

> ðŸ”¥ **è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼**  
> å› ä¸º `jmp` æ˜¯**è¿œè·³è½¬ï¼ˆfar jumpï¼‰**ï¼Œä¼šåŒæ—¶åŠ è½½ `CS` å’Œ `EIP`ï¼Œä»Žè€Œè®© CPU ç”¨æ–°çš„æ®µæè¿°ç¬¦è§£é‡ŠåŽç»­æŒ‡ä»¤ã€‚

### æ­¥éª¤ 5ï¼šè®¾ç½®å…¶ä»–æ®µå¯„å­˜å™¨
```nasm
mov ax, 0x10     ; æ•°æ®æ®µé€‰æ‹©å­ï¼ˆIndex=2ï¼‰
mov ds, ax
mov es, ax
mov ss, ax
; æ³¨æ„ï¼šä¸èƒ½ç›´æŽ¥ mov cs, axï¼
```

### æ­¥éª¤ 6ï¼šè¿›å…¥ 32 ä½ä»£ç æ®µï¼ˆNASM éœ€ç”¨ `[bits 32]`ï¼‰
```nasm
[bits 32]
protected_mode_start:
    ; çŽ°åœ¨ä½ å·²åœ¨ä¿æŠ¤æ¨¡å¼ï¼
    call kernel_main
```

---

## å…­ã€ä¸ºä»€ä¹ˆ GRUB è¦å¸®æˆ‘ä»¬åšè¿™äº›ï¼Ÿ

å› ä¸ºï¼š
- å®žæ¨¡å¼ä¸‹æ— æ³•è®¿é—® 1MB ä»¥ä¸Šå†…å­˜
- æ— æ³•å®žçŽ°å†…å­˜ä¿æŠ¤å’Œå¤šä»»åŠ¡
- **çŽ°ä»£æ“ä½œç³»ç»Ÿå¿…é¡»è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼ï¼ˆæˆ–é•¿æ¨¡å¼ï¼‰ä¸‹**

GRUB åœ¨åŠ è½½ Multiboot å†…æ ¸å‰ï¼Œå·²ç»å®Œæˆäº†ï¼š
1. åŠ è½½ GDT
2. è®¾ç½® CR0.PE = 1
3. è¿œè·³è½¬åˆ° 32 ä½ä»£ç æ®µ
4. è®¾ç½®å¥½æ®µå¯„å­˜å™¨

æ‰€ä»¥ä½ çš„å†…æ ¸ä»£ç **å¤©ç„¶è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼**â€”â€”ä½†è¿™ä¸ç­‰äºŽä½ å¯ä»¥å¿½ç•¥å®ƒï¼

---

## ä¸ƒã€ä¸‹ä¸€æ­¥ï¼šå‡†å¤‡å¼€å¯åˆ†é¡µï¼

è¿›å…¥ä¿æŠ¤æ¨¡å¼åªæ˜¯ç¬¬ä¸€æ­¥ã€‚  
æŽ¥ä¸‹æ¥ï¼Œä½ éœ€è¦ï¼š
- **å¯ç”¨åˆ†é¡µï¼ˆPagingï¼‰** â†’ å®žçŽ°è™šæ‹Ÿå†…å­˜
- **è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆIDTï¼‰** â†’ å¤„ç†å¼‚å¸¸å’Œç¡¬ä»¶ä¸­æ–­
- **åˆå§‹åŒ–å †å’Œå†…å­˜ç®¡ç†å™¨** â†’ ä¸º `kmalloc` æ‰“åŸºç¡€

è€Œè¿™ä¸€åˆ‡ï¼Œéƒ½å»ºç«‹åœ¨**ä½ å·²æŽŒæ¡ä¿æŠ¤æ¨¡å¼**çš„å‰æä¹‹ä¸Šã€‚

---

## å†™åœ¨æœ€åŽ

ä»Žå®žæ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼ï¼Œ  
ä¸ä»…æ˜¯ CPU å·¥ä½œæ–¹å¼çš„æ”¹å˜ï¼Œ  
æ›´æ˜¯**æ“ä½œç³»ç»Ÿä»Žâ€œçŽ©å…·â€èµ°å‘â€œç³»ç»Ÿâ€çš„åˆ†æ°´å²­**ã€‚

ä»Šå¤©ä½ å†™çš„è¿™å‡ è¡Œæ±‡ç¼–ï¼Œ  
æ­£æ˜¯ Linuxã€Windowsã€macOS å†…æ ¸å¯åŠ¨æ—¶ä¹Ÿæ›¾èµ°è¿‡çš„è·¯ã€‚

> ðŸŒŸ **ç†è§£åŽ†å²ï¼Œæ‰èƒ½åˆ›é€ æœªæ¥ã€‚**

---

ðŸ“¬ **åŠ¨æ‰‹è¯•è¯•å§ï¼**  
å³ä½¿ä½ ä¸å†™è£¸æœºå¯åŠ¨ä»£ç ï¼Œä¹Ÿå»ºè®®åœ¨ QEMU ä¸­æ¨¡æ‹Ÿä¸€æ¬¡æ‰‹åŠ¨åˆ‡æ¢è¿‡ç¨‹ã€‚  
æ¬¢è¿Žåœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ GDT å®šä¹‰æˆ–é‡åˆ°çš„å‘ï¼

ðŸ‘‡ ä¸‹ä¸€ç¯‡ä½ æƒ³çœ‹ï¼š**åˆ†é¡µæœºåˆ¶è¯¦è§£**ï¼Œè¿˜æ˜¯ **ä¸­æ–­ä¸Žå¼‚å¸¸å¤„ç†ï¼ˆIDTï¼‰**ï¼Ÿ

---

**#æ“ä½œç³»ç»Ÿ #å†…æ ¸å¼€å‘ #x86 #å®žæ¨¡å¼ #ä¿æŠ¤æ¨¡å¼ #GDT #LDT #æ®µæœºåˆ¶ #ä»Žé›¶å¼€å§‹**

---

> ðŸ“¢ **å½©è›‹**ï¼šå…³æ³¨åŽå›žå¤å…³é”®è¯ **â€œgdtâ€**ï¼ŒèŽ·å–ï¼š
> - å®Œæ•´ GDT æ±‡ç¼–æ¨¡æ¿ï¼ˆå«æ³¨é‡Šï¼‰
> - å®žæ¨¡å¼ â†’ ä¿æŠ¤æ¨¡å¼åˆ‡æ¢çš„ QEMU è°ƒè¯•è„šæœ¬
> - Intel æ‰‹å†Œç›¸å…³ç« èŠ‚æ‘˜å½•ï¼ˆä¸­æ–‡ï¼‰
