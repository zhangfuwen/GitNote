# è°ƒåº¦å™¨ä¸“é¢˜è§„åˆ’ï¼šä»åŸºç¡€åˆ°é«˜çº§çš„å®Œæ•´è·¯çº¿å›¾ï¼ˆå« sched_extï¼‰

> **â€œè°ƒåº¦å™¨æ˜¯æ“ä½œç³»ç»Ÿçš„â€˜äº¤é€šè­¦å¯Ÿâ€™ï¼Œå†³å®š CPU èµ„æºå¦‚ä½•åˆ†é…ã€‚  
> æœ¬ä¸“é¢˜å°†ç³»ç»Ÿæ€§åœ°å‰–æè°ƒåº¦å™¨è®¾è®¡ï¼Œä»é—®é¢˜å®šä¹‰åˆ°ç®—æ³•å®ç°ï¼Œ  
> å¹¶å¼•å…¥ç±»ä¼¼ Linux sched_ext çš„å¯ç¼–ç¨‹è°ƒåº¦æ¡†æ¶ï¼Œ  
> ä¸ºè‡ªåˆ¶ OS æ„å»ºé«˜æ€§èƒ½ã€å¯æ‰©å±•ã€å¯å®šåˆ¶çš„è°ƒåº¦ç³»ç»Ÿã€‚â€**

## ä¸“é¢˜è®¾è®¡å“²å­¦

è°ƒåº¦å™¨ä¸“é¢˜å°†é‡‡ç”¨**é—®é¢˜é©±åŠ¨ã€æ¸è¿›æ¼”è¿›ã€å¯ç¼–ç¨‹æ‰©å±•**çš„å†™ä½œè·¯çº¿ï¼š
- **æ·±åº¦**ï¼šæ¯ç¯‡æ·±å…¥ä¸€ä¸ªè°ƒåº¦é—®é¢˜æˆ–ç®—æ³•
- **å¹¿åº¦**ï¼šè¦†ç›–ä»å•æ ¸åˆ°å¤šæ ¸ã€ä»æ‰¹å¤„ç†åˆ°å®æ—¶
- **å®è·µ**ï¼šæä¾›å¯è¿è¡Œçš„ç®€åŒ–å®ç°æ¡†æ¶
- **å¯¹æ¯”**ï¼šåˆ†æä¸åŒç®—æ³•çš„é€‚ç”¨åœºæ™¯

---

## ğŸ“š **è°ƒåº¦å™¨ä¸“é¢˜ï¼š7 ç¯‡å®Œæ•´è·¯çº¿å›¾**

### **ç¬¬ä¸€ç¯‡ï¼šè°ƒåº¦åŸºç¡€ä¸è®¾è®¡æ¡†æ¶**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-åŸºç¡€ç¯‡ï¼šCPU èµ„æºåˆ†é…çš„æ ¸å¿ƒé—®é¢˜ä¸è®¾è®¡æ¡†æ¶ã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- è°ƒåº¦è¦è§£å†³çš„ä¸‰å¤§é—®é¢˜ï¼šå…¬å¹³æ€§ã€å“åº”æ€§ã€ååé‡  
- è°ƒåº¦æ—¶æœºï¼šæ—¶é’Ÿä¸­æ–­ã€ç³»ç»Ÿè°ƒç”¨ã€I/O é˜»å¡  
- è°ƒåº¦æ¡†æ¶è®¾è®¡ï¼šè¿è¡Œé˜Ÿåˆ—ã€ä»»åŠ¡çŠ¶æ€ã€ä¸Šä¸‹æ–‡åˆ‡æ¢  
- è°ƒåº¦ç­–ç•¥ vs è°ƒåº¦æœºåˆ¶åˆ†ç¦»  

> âœ… **è§£å†³**ï¼šâ€è°ƒåº¦å™¨åˆ°åº•è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•è®¾è®¡å¯æ‰©å±•çš„è°ƒåº¦æ¡†æ¶ï¼Ÿâ€œ

---

### **ç¬¬äºŒç¯‡ï¼šç»å…¸è°ƒåº¦ç®—æ³•å®ç°**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-ç»å…¸ç¯‡ï¼šå®ç° FIFOã€Round-Robin ä¸ Multilevel Queueã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- FIFOï¼ˆå…ˆæ¥å…ˆæœåŠ¡ï¼‰ï¼šç®€å•ä½†å“åº”æ€§å·®  
- Round-Robinï¼ˆæ—¶é—´ç‰‡è½®è½¬ï¼‰ï¼šå…¬å¹³ä½†å¼€é”€å¤§  
- Multilevel Queueï¼ˆå¤šçº§é˜Ÿåˆ—ï¼‰ï¼šI/O å¯†é›† vs CPU å¯†é›†  
- æ—¶é—´ç‰‡åŠ¨æ€è°ƒæ•´ç­–ç•¥  
- **ç®—æ³•æ’ä»¶åŒ–**ï¼šé€šè¿‡ç»Ÿä¸€æ¥å£æ³¨å†Œ  

> âœ… **è§£å†³**ï¼šâ€å¦‚ä½•å®ç°ç»å…¸è°ƒåº¦ç®—æ³•ï¼Ÿå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿâ€œ

---

### **ç¬¬ä¸‰ç¯‡ï¼šå¤šæ ¸è°ƒåº¦ä¸è´Ÿè½½å‡è¡¡**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-å¤šæ ¸ç¯‡ï¼šSMP è°ƒåº¦ä¸è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- å¤šæ ¸è°ƒåº¦æŒ‘æˆ˜ï¼šç¼“å­˜äº²å’Œæ€§ã€é”ç«äº‰  
- è°ƒåº¦åŸŸï¼ˆScheduling Domainï¼‰è®¾è®¡  
- è´Ÿè½½å‡è¡¡ï¼šç©ºé—²æ ¸å”¤é†’ã€å¿™æ ¸è¿ç§»  
- CPU äº²å’Œæ€§ï¼ˆaffinityï¼‰æ”¯æŒ  

> âœ… **è§£å†³**ï¼šâ€å¤šæ ¸ç¯å¢ƒä¸‹å¦‚ä½•é«˜æ•ˆåˆ†é…ä»»åŠ¡ï¼Ÿâ€œ

---

### **ç¬¬å››ç¯‡ï¼šå®æ—¶è°ƒåº¦ç®—æ³•**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-å®æ—¶ç¯‡ï¼šå®ç° Rate-Monotonic ä¸ Earliest-Deadline-Firstã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- å®æ—¶ç³»ç»Ÿåˆ†ç±»ï¼šç¡¬å®æ—¶ vs è½¯å®æ—¶  
- Rate-Monotonic Schedulingï¼ˆRMSï¼‰ï¼šé™æ€ä¼˜å…ˆçº§  
- Earliest-Deadline-Firstï¼ˆEDFï¼‰ï¼šåŠ¨æ€ä¼˜å…ˆçº§  
- ä¼˜å…ˆçº§åè½¬é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ  
- **å®æ—¶è°ƒåº¦æ’ä»¶**ï¼šsched_ext å®æ—¶æ‰©å±•  

> âœ… **è§£å†³**ï¼šâ€å¦‚ä½•æ”¯æŒå®æ—¶ä»»åŠ¡ï¼Ÿä¿è¯æˆªæ­¢æ—¶é—´ï¼Ÿâ€œ

---

### **ç¬¬äº”ç¯‡ï¼šç°ä»£è°ƒåº¦å™¨è®¾è®¡ï¼šCFS ä¸å…¬å¹³è°ƒåº¦**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-ç°ä»£ç¯‡ï¼šå®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼ˆCFSï¼‰çš„æ ¸å¿ƒæ€æƒ³ä¸å®ç°ã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- CFS æ ¸å¿ƒæ€æƒ³ï¼šè™šæ‹Ÿè¿è¡Œæ—¶é—´ï¼ˆvruntimeï¼‰  
- çº¢é»‘æ ‘ç®¡ç†è¿è¡Œé˜Ÿåˆ—  
- è°ƒåº¦å‘¨æœŸä¸æœ€å°ç²’åº¦  
- ç»„è°ƒåº¦ï¼ˆGroup Schedulingï¼‰  
- **CFS ä½œä¸º sched_ext æ’ä»¶**  

> âœ… **è§£å†³**ï¼šâ€CFS å¦‚ä½•å®ç°â€˜å®Œå…¨å…¬å¹³â€™ï¼Ÿä¸ºä»€ä¹ˆæˆä¸º Linux é»˜è®¤è°ƒåº¦å™¨ï¼Ÿâ€œ

---

### **ç¬¬å…­ç¯‡ï¼šå¯ç¼–ç¨‹è°ƒåº¦ï¼šsched_ext æ¡†æ¶è®¾è®¡**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-sched_ext ç¯‡ï¼šæ„å»ºå¯ç¼–ç¨‹è°ƒåº¦æ¡†æ¶ã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- **sched_ext æ ¸å¿ƒæ€æƒ³**ï¼šç”¨æˆ·æ€è°ƒåº¦ç­–ç•¥ + å†…æ ¸æ€è°ƒåº¦æœºåˆ¶  
- eBPF-like è°ƒåº¦ç¨‹åºï¼šç”¨å®‰å…¨å­—èŠ‚ç å®šä¹‰è°ƒåº¦é€»è¾‘  
- è°ƒåº¦äº‹ä»¶é’©å­ï¼šenqueue/dequeue/pick_next_task  
- æ€§èƒ½éš”ç¦»ï¼šè°ƒåº¦ç¨‹åºèµ„æºé™åˆ¶  
- **è‡ªåˆ¶ OS çš„ç®€åŒ– sched_ext å®ç°**  

> âœ… **è§£å†³**ï¼šâ€å¦‚ä½•è®©è°ƒåº¦ç­–ç•¥å¯ç¼–ç¨‹ï¼Ÿç”¨æˆ·æ€å¦‚ä½•å®šä¹‰è°ƒåº¦é€»è¾‘ï¼Ÿâ€œ

---

### **ç¬¬ä¸ƒç¯‡ï¼šè°ƒåº¦å™¨é«˜çº§ç‰¹æ€§**
**æ ‡é¢˜**ï¼šã€Šè°ƒåº¦å™¨-é«˜çº§ç¯‡ï¼šèŠ‚èƒ½è°ƒåº¦ã€NUMA äº²å’Œæ€§ä¸å®¹å™¨æ”¯æŒã€‹  
**æ ¸å¿ƒå†…å®¹**ï¼š  
- èŠ‚èƒ½è°ƒåº¦ï¼šCPU é¢‘ç‡è°ƒèŠ‚ã€æ ¸ä¼‘çœ   
- NUMA äº²å’Œæ€§ï¼šæœ¬åœ°å†…å­˜ä¼˜å…ˆ  
- å®¹å™¨æ”¯æŒï¼šcgroups èµ„æºé™åˆ¶  
- è°ƒåº¦å™¨è°ƒè¯•ä¸æ€§èƒ½åˆ†æ  
- **sched_ext é«˜çº§ç”¨ä¾‹**ï¼šAI é©±åŠ¨çš„è°ƒåº¦ç­–ç•¥  

> âœ… **è§£å†³**ï¼šâ€ç°ä»£è°ƒåº¦å™¨å¦‚ä½•æ”¯æŒé«˜çº§ä¼ä¸šç‰¹æ€§ï¼Ÿâ€œ

---

## ğŸ”‘ **ä¸“é¢˜è®¾è®¡äº®ç‚¹**

### 1. **sched_ext åˆ›æ–°ç‚¹**
- **ç¬¬å…­ç¯‡ä¸“é—¨è®²è§£å¯ç¼–ç¨‹è°ƒåº¦**
- **å‰äº”ç¯‡ç®—æ³•å‡å¯ä½œä¸º sched_ext æ’ä»¶å®ç°**
- **è‡ªåˆ¶ OS çš„ç®€åŒ–ç‰ˆ**ï¼šç”¨ C å‡½æ•°æŒ‡é’ˆæ›¿ä»£ eBPF

### 2. **é—®é¢˜é©±åŠ¨**
æ¯ç¯‡ä»**å®é™…è°ƒåº¦é—®é¢˜**å‡ºå‘ï¼š
- â€œå¦‚ä½•ä¿è¯äº¤äº’å¼ä»»åŠ¡å“åº”å¿«ï¼Ÿâ€
- â€œå¤šæ ¸ä¸‹å¦‚ä½•é¿å…ç¼“å­˜é¢ ç°¸ï¼Ÿâ€
- â€œå®æ—¶ä»»åŠ¡å¦‚ä½•ä¿è¯æˆªæ­¢æ—¶é—´ï¼Ÿâ€
- â€œç”¨æˆ·å¦‚ä½•è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥ï¼Ÿâ€

### 3. **æ¸è¿›æ¼”è¿›**
- **å•æ ¸ â†’ å¤šæ ¸**
- **ç®€å•ç®—æ³• â†’ å¤æ‚ç®—æ³•**
- **å›ºå®šç­–ç•¥ â†’ å¯ç¼–ç¨‹ç­–ç•¥**

### 4. **å®è·µå¯¼å‘**
- æ¯ç¯‡åŒ…å«**å¯è¿è¡Œçš„ç®€åŒ–å®ç°**
- æä¾›**æ€§èƒ½æµ‹è¯•æ–¹æ³•**
- ç»™å‡º**é€‚ç”¨åœºæ™¯å»ºè®®**

---

## ğŸ“Œ **sched_ext åœ¨è‡ªåˆ¶ OS ä¸­çš„ç®€åŒ–å®ç°**

### æ ¸å¿ƒè®¾è®¡ï¼š
- **è°ƒåº¦ç­–ç•¥**ï¼šç”¨æˆ·æ€ C å‡½æ•°ï¼ˆæ³¨å†Œåˆ°å†…æ ¸ï¼‰
- **è°ƒåº¦æœºåˆ¶**ï¼šå†…æ ¸æä¾›äº‹ä»¶é’©å­
- **å®‰å…¨**ï¼šé€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼Œæ—  JIT

### æ•°æ®ç»“æ„ï¼š
```c
// sched_ext.h
struct sched_ext_ops {
    void (*enqueue_task)(struct task *task);
    void (*dequeue_task)(struct task *task);
    struct task *(*pick_next_task)(void);
    void (*task_tick)(struct task *task);
};

// æ³¨å†Œè°ƒåº¦ç­–ç•¥
int register_sched_policy(const char *name, struct sched_ext_ops *ops);
```

### ä½¿ç”¨ç¤ºä¾‹ï¼š
```c
// user/sched_rr.c
static void rr_enqueue(struct task *task) {
    // Round-Robin å…¥é˜Ÿé€»è¾‘
}

static struct task *rr_pick_next(void) {
    // Round-Robin é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡
}

static struct sched_ext_ops rr_ops = {
    .enqueue_task = rr_enqueue,
    .pick_next_task = rr_pick_next,
};

// æ³¨å†Œåˆ°å†…æ ¸
int main() {
    register_sched_policy("round_robin", &rr_ops);
    return 0;
}
```

