ä»¥ä¸‹æ˜¯æ ¹æ®èŠå¤©å†…å®¹æ•´ç†çš„æŠ€æœ¯æ–‡æ¡£ï¼Œæ¶µç›– Linux å†…å­˜ç®¡ç†ã€å†…æ ¸é¡µè¡¨ã€ä»»åŠ¡çŠ¶æ€æ®µï¼ˆTSSï¼‰ç­‰æ ¸å¿ƒæœºåˆ¶ï¼š

---

# **Linux å†…å­˜ç®¡ç†ä¸å†…æ ¸æœºåˆ¶æ€»ç»“**

## **1. å†…å­˜åŒºåŸŸï¼ˆZonesï¼‰**
### **1.1 32 ä½ç³»ç»Ÿçš„å†…å­˜åˆ’åˆ†**
| **Zone**       | **ç‰©ç†åœ°å€èŒƒå›´**       | **è™šæ‹Ÿåœ°å€èŒƒå›´**       | **ç”¨é€”**                     |
|----------------|-----------------------|-----------------------|-----------------------------|
| `ZONE_DMA`     | `0x00000000 - 0x00FFFFFF` | `0xC0000000 - 0xC0FFFFFF` | DMA è®¾å¤‡ä¸“ç”¨å†…å­˜ï¼ˆ16MBï¼‰      |
| `ZONE_NORMAL`  | `0x01000000 - 0x37FFFFFF` | `0xC1000000 - 0xF7FFFFFF` | å¸¸è§„å†…æ ¸å’Œç”¨æˆ·å†…å­˜ï¼ˆ880MBï¼‰    |
| `ZONE_HIGHMEM` | `0x38000000 - ç‰©ç†å†…å­˜æœ«å°¾` | åŠ¨æ€æ˜ å°„ï¼ˆ`kmap`ï¼‰       | è¶…å‡º 896MB çš„ç‰©ç†å†…å­˜          |

### **1.2 64 ä½ç³»ç»Ÿçš„å˜åŒ–**
- **æ—  `ZONE_HIGHMEM`**ï¼šæ‰€æœ‰ç‰©ç†å†…å­˜é€šè¿‡ç›´æ¥æ˜ å°„åŒºï¼ˆ`0xFFFF800000000000` èµ·ï¼‰çº¿æ€§æ˜ å°„ã€‚
- **`ZONE_DMA` å’Œ `ZONE_DMA32`**ï¼šä¿ç•™ç”¨äºå…¼å®¹ DMA è®¾å¤‡ã€‚

---

## **2. ç‰©ç†å†…å­˜åˆ†é…**
### **2.1 `alloc_pages`**
- **åŠŸèƒ½**ï¼šåˆ†é…è¿ç»­çš„ç‰©ç†é¡µã€‚
- **ç‰¹æ€§**ï¼š
  - è¿”å› `2^order` ä¸ªæ•´æ•°é¡µï¼ˆå¦‚ `order=2` åˆ†é… 4 é¡µï¼‰ã€‚
  - ç‰©ç†åœ°å€è¿ç»­ï¼Œé€šè¿‡ Buddy Allocator å®ç°ã€‚
- **ç¤ºä¾‹**ï¼š
  ```c
  struct page *page = alloc_pages(GFP_KERNEL, 2); // åˆ†é… 4 é¡µï¼ˆ16KBï¼‰
  ```

### **2.2 `vmalloc` ä¸ `kmap`**
| **æœºåˆ¶**       | **è™šæ‹Ÿåœ°å€èŒƒå›´**               | **ç‰©ç†å†…å­˜æ¥æº**       | **ç”¨é€”**                     |
|----------------|-------------------------------|-----------------------|-----------------------------|
| `vmalloc`      | `0xF8000000 - 0xFFFFFFFF`ï¼ˆ32 ä½ï¼‰ | éè¿ç»­ç‰©ç†é¡µ           | å¤§å—éè¿ç»­å†…å­˜åˆ†é…            |
| `kmap`         | `0xFFC00000 - 0xFFE00000`ï¼ˆFixmapï¼‰ | `ZONE_HIGHMEM`        | ä¸´æ—¶æ˜ å°„é«˜ç«¯å†…å­˜              |

---

## **3. å†…æ ¸é¡µè¡¨ç®¡ç†**
### **3.1 ç›´æ¥æ˜ å°„åŒºï¼ˆDirect Mapï¼‰**
- **64 ä½ç³»ç»Ÿ**ï¼šæ‰€æœ‰ç‰©ç†å†…å­˜é€šè¿‡å›ºå®šåç§»ï¼ˆå¦‚ `0xFFFF800000000000`ï¼‰çº¿æ€§æ˜ å°„ã€‚
- **é¡µè¡¨é¡¹æ•°é‡**ï¼šä¸ç‰©ç†å†…å­˜å®¹é‡ç›¸å…³ï¼ˆ`é¡µè¡¨é¡¹æ•° = ç‰©ç†å†…å­˜å¤§å° / é¡µå¤§å°`ï¼‰ã€‚

### **3.2 é¡µè¡¨å±‚çº§ï¼ˆx86_64ï¼‰**
| **å±‚çº§**       | **è¦†ç›–èŒƒå›´**       | **æ¡ç›®æ•°** | **ä½œç”¨**                     |
|----------------|-------------------|-----------|-----------------------------|
| PML4           | 512GB             | 512       | é¡¶çº§é¡µè¡¨                     |
| PDPT           | 1GB               | 512       | äºŒçº§é¡µè¡¨                     |
| PD             | 2MB               | 512       | ä¸‰çº§é¡µè¡¨                     |
| PT             | 4KB               | 512       | å››çº§é¡µè¡¨ï¼ˆæœ€ç»ˆæ˜ å°„åˆ°ç‰©ç†é¡µï¼‰   |

---

## **4. ä»»åŠ¡çŠ¶æ€æ®µï¼ˆTSSï¼‰**
### **4.1 å…³é”®å­—æ®µ**
| **å­—æ®µ** | **ä½œç”¨**                                                                 |
|----------|-------------------------------------------------------------------------|
| `esp0`   | å†…æ ¸æ ˆæŒ‡é’ˆï¼Œç”¨æˆ·æ€â†’å†…æ ¸æ€åˆ‡æ¢æ—¶æ›´æ–°æ ˆã€‚                                   |
| `ss0`    | å†…æ ¸æ ˆæ®µå¯„å­˜å™¨ï¼ˆé€šå¸¸ä¸º `__KERNEL_DS`ï¼‰ã€‚                                 |
| `cr3`    | é¡µç›®å½•åŸºå€ï¼Œä»»åŠ¡åˆ‡æ¢æ—¶æ›´æ–°ä»¥å®ç°åœ°å€ç©ºé—´éš”ç¦»ã€‚                            |

### **4.2 ä»»åŠ¡åˆ‡æ¢æµç¨‹**
1. ä¿å­˜å½“å‰ä»»åŠ¡çš„å¯„å­˜å™¨çŠ¶æ€åˆ° TSSã€‚
2. åŠ è½½æ–°ä»»åŠ¡çš„ `cr3`ï¼ˆåˆ‡æ¢é¡µè¡¨ï¼‰ã€‚
3. æ›´æ–° `esp0` å’Œ `ss0`ï¼ˆåˆ‡æ¢å†…æ ¸æ ˆï¼‰ã€‚
4. æ¢å¤æ–°ä»»åŠ¡çš„å¯„å­˜å™¨çŠ¶æ€ã€‚

---

## **5. ç”¨æˆ·æ€å†…å­˜åˆ†é…**
### **5.1 `mmap` åŒ¿åé¡µåˆ†é…**
- **ç‰©ç†å†…å­˜æ¥æº**ï¼šä¼˜å…ˆä» `ZONE_NORMAL` åˆ†é…ï¼Œä¸è¶³æ—¶ä½¿ç”¨ `ZONE_HIGHMEM`ã€‚
- **é¡µè¡¨é¡¹**ï¼šç”¨æˆ·æ€è™šæ‹Ÿåœ°å€å¿…é¡»é€šè¿‡é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†é¡µï¼ˆç¼ºé¡µå¼‚å¸¸è§¦å‘åˆ†é…ï¼‰ã€‚

### **5.2 Buddy Allocator**
- **æ¯ä¸ª Zone ç‹¬ç«‹**ï¼š`ZONE_DMA`ã€`ZONE_NORMAL` ç­‰å‡æœ‰ç‹¬ç«‹çš„ Buddy Allocator ç®¡ç†ç©ºé—²é¡µã€‚
- **åˆ†é…ä¼˜å…ˆçº§**ï¼š`ZONE_DMA â†’ ZONE_NORMAL â†’ ZONE_HIGHMEM`ï¼ˆ32 ä½ï¼‰ã€‚

---

## **6. å…³é”®ç»“è®º**
1. **32 ä½ç³»ç»Ÿ**ï¼š`ZONE_HIGHMEM` ç”¨äºè®¿é—®è¶…å‡º 896MB çš„å†…å­˜ï¼Œéœ€åŠ¨æ€æ˜ å°„ã€‚
2. **64 ä½ç³»ç»Ÿ**ï¼šæ—  `ZONE_HIGHMEM`ï¼Œæ‰€æœ‰ç‰©ç†å†…å­˜ç›´æ¥æ˜ å°„ã€‚
3. **DMA Zone**ï¼šå‰ 4MB å¯åˆ†é…ï¼Œé™¤éè¢« BIOS ä¿ç•™ã€‚
4. **ä»»åŠ¡åˆ‡æ¢**ï¼šTSS çš„ `esp0`ã€`ss0` å’Œ `cr3` æ˜¯å®ç°å†…æ ¸æ ˆå’Œåœ°å€ç©ºé—´éš”ç¦»çš„æ ¸å¿ƒã€‚

---

**é™„å½•ï¼šå¸¸ç”¨å‘½ä»¤**
```bash
# æŸ¥çœ‹å†…å­˜åŒºåŸŸä¿¡æ¯
cat /proc/zoneinfo

# æŸ¥çœ‹å†…æ ¸è™šæ‹Ÿåœ°å€æ˜ å°„
cat /proc/vmallocinfo

# æŸ¥çœ‹é¡µè¡¨ç»Ÿè®¡
grep "DirectMap" /proc/meminfo
```

--- 

æœ¬æ–‡æ¡£å¯ä½œä¸º Linux å†…å­˜ç®¡ç†å’Œå†…æ ¸æœºåˆ¶çš„å¿«é€Ÿå‚è€ƒæŒ‡å—ã€‚




# **Linux ä¸­çš„ xarray åŠå…¶ API ä½¿ç”¨è¯¦è§£**

**`xarray`** æ˜¯ Linux å†…æ ¸ä¸­ä¸€ä¸ªé«˜æ•ˆã€çº¿ç¨‹å®‰å…¨ä¸”é€‚ç”¨äºç¨€ç–æ•°æ®å­˜å‚¨çš„æ•°æ®ç»“æ„ã€‚å®ƒä» Linux v4.20 ç‰ˆæœ¬å¼€å§‹å¼•å…¥ï¼Œç›®çš„æ˜¯å–ä»£æ—§çš„ `radix_tree` å’Œ `idr` æ¥å£ï¼Œæä¾›æ›´ç»Ÿä¸€ã€æ›´æ˜“ç”¨ã€æ›´é«˜æ•ˆçš„é”®å€¼å¯¹ç®¡ç†æ–¹å¼ã€‚

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» `xarray` çš„æ¦‚å¿µã€è®¾è®¡åˆè¡·ä»¥åŠå¦‚ä½•åœ¨å†…æ ¸æ¨¡å—æˆ–ç³»ç»Ÿç¼–ç¨‹ä¸­ä½¿ç”¨å®ƒçš„ä¸»è¦ APIã€‚

---

## ğŸ” ä»€ä¹ˆæ˜¯ `xarray`ï¼Ÿ

`xarray` æ˜¯ä¸€ç§åŸºäºåŸºæ•°æ ‘ï¼ˆradix treeï¼‰ä¼˜åŒ–çš„ç¨€ç–æ•°ç»„å®ç°ã€‚å®ƒç”¨äºå°† **64 ä½æ•´æ•°ç´¢å¼•ï¼ˆindexï¼‰** æ˜ å°„ä¸ºä»»æ„æŒ‡é’ˆï¼ˆvoid *ï¼‰ï¼Œéå¸¸é€‚åˆå¤„ç†ï¼š

- æ–‡ä»¶é¡µç¼“å­˜ï¼ˆpage cacheï¼‰
- ID åˆ°æŒ‡é’ˆçš„æ˜ å°„
- è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼‰è·Ÿè¸ª
- è®¾å¤‡é©±åŠ¨èµ„æºç®¡ç†

### ğŸ“Œ ä¸»è¦ç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| âœ… ç¨€ç–å­˜å‚¨ | åªå­˜å‚¨æœ‰å†…å®¹çš„ä½ç½®ï¼ŒèŠ‚çœå†…å­˜ |
| âœ… æ”¯æŒ 64 ä½ç´¢å¼• | æ”¯æŒéå¸¸å¤§çš„ç´¢å¼•ç©ºé—´ï¼ˆ0 ~ 2^64 -1ï¼‰ |
| âœ… çº¿ç¨‹å®‰å…¨ | æ”¯æŒå¹¶å‘è®¿é—®ï¼Œæ— éœ€é¢å¤–åŠ é” |
| âœ… ç»Ÿä¸€æ¥å£ | æ›¿ä»£äº† `radix_tree` å’Œ `idr` |
| âœ… æ ‡è®°æ”¯æŒï¼ˆTagsï¼‰ | ç±»ä¼¼äº radix_tree çš„æ ‡ç­¾æœºåˆ¶ |
| âœ… é¢„åˆ†é…æ”¯æŒ | æ”¯æŒåŸå­ä¸Šä¸‹æ–‡ä¸­çš„æ“ä½œ |

---

## ğŸ§  ä¸ºä»€ä¹ˆå¼•å…¥ `xarray`ï¼Ÿ

åœ¨ `xarray` å‡ºç°ä¹‹å‰ï¼ŒLinux å†…æ ¸å¹¿æ³›ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§ç»“æ„æ¥å¤„ç†é”®å€¼æ˜ å°„ï¼š

- `radix_tree`ï¼šç”¨äº page cache å’Œå…¶ä»–ç¨€ç–æ•°ç»„ï¼Œä½†æ¥å£å¤æ‚ï¼Œéœ€æ‰‹åŠ¨åŠ é”ã€‚
- `idr`ï¼šç”¨äºå°†æ•´æ•° ID æ˜ å°„ä¸ºæŒ‡é’ˆï¼Œä½†åŠŸèƒ½æœ‰é™ã€‚

å› æ­¤ï¼Œ`xarray` åº”è¿è€Œç”Ÿï¼Œèåˆäº†ä¸¤è€…çš„ä¼˜åŠ¿ï¼š
- æ€§èƒ½ä¸ `radix_tree` ç›¸å½“ç”šè‡³æ›´å¥½
- æ¥å£ç®€æ´ç»Ÿä¸€ï¼Œæ˜“äºä½¿ç”¨
- æ”¯æŒå¹¶å‘è®¿é—®å’Œè¿­ä»£å™¨
- æ›´å¥½çš„é”™è¯¯å¤„ç†æœºåˆ¶

---

## ğŸ§± æ ¸å¿ƒæ•°æ®ç»“æ„

```c
struct xarray {
    unsigned long xa_flags;
    void *xa_head;
    gfp_t xa_gfp_mask;
};
```

- `xa_head`ï¼šæŒ‡å‘å†…éƒ¨æ ‘ç»“æ„çš„æ ¹èŠ‚ç‚¹
- `xa_flags`ï¼šæ§åˆ¶è¡Œä¸ºï¼ˆå¦‚æ˜¯å¦å…è®¸ä¸­æ–­ä¸Šä¸‹æ–‡åˆ†é…å†…å­˜ï¼‰
- `xa_gfp_mask`ï¼šåˆ†é…å†…å­˜æ—¶ä½¿ç”¨çš„æ ‡å¿—ä½

ä½ å¯ä»¥é€šè¿‡å®å®šä¹‰å£°æ˜ä¸€ä¸ª `xarray`ï¼š

```c
XARRAY(my_xa, XA_FLAGS_ALLOC);  // å®šä¹‰å¹¶åˆå§‹åŒ–ä¸€ä¸ª xarray
```

---

## ğŸ§ª å¸¸ç”¨ API æ“ä½œ

ä»¥ä¸‹æ˜¯ `xarray` æœ€å¸¸ç”¨çš„å‡ ä¸ªæ¥å£å‡½æ•°ï¼š

### 1. **æ’å…¥/æ›´æ–°æ¡ç›®**
```c
int xa_store(struct xarray *xa, unsigned long index,
             void *entry, gfp_t gfp);
```

ç¤ºä¾‹ï¼š
```c
xa_store(&my_xa, 123, my_pointer, GFP_KERNEL);
```

---

### 2. **è¯»å–æ¡ç›®**
```c
void *xa_load(struct xarray *xa, unsigned long index);
```

ç¤ºä¾‹ï¼š
```c
void *ptr = xa_load(&my_xa, 123);
```

---

### 3. **åˆ é™¤æ¡ç›®**
```c
void xa_erase(struct xarray *xa, unsigned long index);
```

ç¤ºä¾‹ï¼š
```c
xa_erase(&my_xa, 123);
```

---

### 4. **åŸå­æ›¿æ¢**
```c
void *xa_cmpxchg(struct xarray *xa, unsigned long index,
                 void *old, void *store, gfp_t gfp);
```

ç¤ºä¾‹ï¼š
```c
xa_cmpxchg(&my_xa, 123, old_ptr, new_ptr, GFP_KERNEL);
```

---

### 5. **è‡ªåŠ¨åˆ†é…ç´¢å¼•**
```c
int xa_alloc(struct xarray *xa, u32 *id, void *entry,
             struct xa_limit limit, gfp_t gfp);
```

ç¤ºä¾‹ï¼š
```c
u32 id;
xa_alloc(&my_xa, &id, ptr, XA_LIMIT(0, 1000), GFP_KERNEL);
```

---

### 6. **éå†æ‰€æœ‰æœ‰æ•ˆé¡¹**
```c
unsigned long index;
void *entry;

xa_for_each (&my_xa, index, entry) {
    printk(KERN_INFO "Index %lu: %p\n", index, entry);
}
```

---

## âš™ï¸ é”æœºåˆ¶ä¸å¹¶å‘æ§åˆ¶

`xarray` æä¾›äº†å¤šç§è®¿é—®æ¨¡å¼ä»¥æ”¯æŒå¤šçº¿ç¨‹åœºæ™¯ï¼š

| æ¨¡å¼ | æ˜¯å¦éœ€è¦é” | é€‚ç”¨åœºæ™¯ |
|------|-------------|----------|
| `GFP_KERNEL` | å¦ | é»˜è®¤æ¨¡å¼ |
| `GFP_ATOMIC` | å¦ | ä¸­æ–­ä¸Šä¸‹æ–‡ |
| `XA_TRYLOCK` | æ˜¯ | å¤šçº¿ç¨‹å†™å…¥æ—¶æ‰‹åŠ¨åŠ é” |

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å®è¿›è¡Œæ‰‹åŠ¨åŠ é”ï¼š

```c
unsigned long flags;

xa_lock_irqsave(&my_xa, flags);
... // ä¿®æ”¹ xarray
xa_unlock_irqrestore(&my_xa, flags);
```

---

## ğŸ“¦ åœ¨ Linux å†…æ ¸ä¸­çš„å…¸å‹åº”ç”¨åœºæ™¯

### 1. **Page Cache ç®¡ç†**

æ›¿ä»£äº†ä¼ ç»Ÿçš„ `radix_tree`ï¼Œç”¨äºç®¡ç†æ–‡ä»¶å¯¹åº”çš„å†…å­˜é¡µç¼“å­˜ï¼š

```c
struct address_space {
    struct xarray i_pages;   // æ›¿ä»£åŸæ¥çš„ radix_tree
    ...
};
```

- ç”¨åç§»é‡ä½œä¸º key
- å­˜å‚¨ `struct page *` æˆ– `struct folio *`

---

### 2. **IDR æ›¿ä»£**

å®Œå…¨æ›¿ä»£ `idr` æ¥å£ï¼Œç”¨äºæ•´æ•° ID åˆ°æŒ‡é’ˆçš„æ˜ å°„ï¼š

```c
XARRAY(my_xa, XA_FLAGS_ALLOC);
DEFINE_XARRAY_FLAGS(my_xa, XA_FLAGS_ALLOC); // for newer versions

// åˆ†é…æ–° ID å¹¶å…³è”æŒ‡é’ˆ
unsigned long id;
void *ptr = kmalloc(...);

int ret = xa_alloc(&my_xa, &id, ptr, XA_LIMIT(0, 1000), GFP_KERNEL);
```

---

### 3. **è®¾å¤‡é©±åŠ¨ä¸­çš„å¥æŸ„ç®¡ç†**

è®¸å¤šè®¾å¤‡é©±åŠ¨ä½¿ç”¨ `xarray` æ¥ç®¡ç†ï¼š
- GPU å¯¹è±¡ï¼ˆå¦‚ DRM/KMSï¼‰
- å†…å­˜åŒºåŸŸï¼ˆmemory regionsï¼‰
- æ–‡ä»¶æè¿°ç¬¦æ˜ å°„ç­‰èµ„æº

---

## ğŸ§© ä½¿ç”¨ `xarray` çš„ä¼˜åŠ¿

| ä¼˜ç‚¹ | æè¿° |
|------|------|
| âœ… é«˜æ•ˆæŸ¥æ‰¾/æ’å…¥/åˆ é™¤ | O(log n) æ—¶é—´å¤æ‚åº¦ |
| âœ… ç¨€ç–ç´¢å¼• | ä¸æµªè´¹å†…å­˜ |
| âœ… çº¿ç¨‹å®‰å…¨ | æ”¯æŒå¹¶å‘è®¿é—® |
| âœ… æ¥å£ç»Ÿä¸€ | æ›¿ä»£å¤šä¸ªæ—§æ¥å£ |
| âœ… è¿­ä»£å™¨æ”¯æŒ | å¼ºå¤§ä¸”æ˜“ç”¨ |
| âœ… æ›´é€‚åˆç°ä»£å†…æ ¸ | æ”¯æŒæ ‡è®°ã€é¢„åˆ†é…ç­‰æ‰©å±•åŠŸèƒ½ |

---

## ğŸ§ª ç¤ºä¾‹ä»£ç ï¼ˆå†…æ ¸æ¨¡å—ï¼‰

```c
#include <linux/module.h>
#include <linux/xarray.h>

MODULE_LICENSE("GPL");

// XARRAY(my_xa, XA_FLAGS_ALLOC);
DEFINE_XARRAY_FLAGS(my_xa, XA_FLAGS_ALLOC);

static int __init my_init(void)
{
    void *ptr = kmalloc(1024, GFP_KERNEL);
    unsigned long index = 123;

    xa_store(&my_xa, index, ptr, GFP_KERNEL);

    void *entry = xa_load(&my_xa, index);
    pr_info("Loaded: %p\n", entry);

    xa_for_each (&my_xa, index, entry) {
        pr_info("Found index %lu: %p\n", index, entry);
    }

    return 0;
}

static void __exit my_exit(void)
{
    unsigned long index;
    void *entry;

    xa_for_each (&my_xa, index, entry) {
        kfree(entry);
        xa_erase(&my_xa, index);
    }
}

module_init(my_init);
module_exit(my_exit);
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿å¯¹æ¯”ï¼ˆvs radix_treeï¼‰

| ç‰¹æ€§ | `radix_tree` | `xarray` |
|------|---------------|-----------|
| æ¥å£ä¸€è‡´æ€§ | âŒ åˆ†æ•£ | âœ… ç»Ÿä¸€ |
| å¹¶å‘æ”¯æŒ | âŒ éœ€å¤–éƒ¨é” | âœ… å†…ç½®å¹¶å‘æ§åˆ¶ |
| è¿­ä»£å™¨æ”¯æŒ | âŒ ä¸å‹å¥½ | âœ… å¼ºå¤§è¿­ä»£å™¨ |
| é”™è¯¯å¤„ç† | âŒ å¤æ‚ | âœ… æ¸…æ™°è¿”å›ç  |
| æ‰©å±•èƒ½åŠ› | âŒ å›°éš¾ | âœ… æ˜“äºæ·»åŠ æ–°ç‰¹æ€§ |

---

## ğŸ§© æ€»ç»“

| å±æ€§ | æè¿° |
|------|------|
| åç§° | `xarray` |
| ç±»å‹ | ç¨€ç–é”®å€¼æ˜ å°„ç»“æ„ |
| åº•å±‚ç»“æ„ | åŸºäºåŸºæ•°æ ‘ä¼˜åŒ– |
| ä¸»è¦ç”¨é€” | page cacheã€IDRã€èµ„æºç®¡ç† |
| ç´¢å¼•ç±»å‹ | 64-bit æ•´æ•° |
| æ•°æ®ç±»å‹ | void *ï¼ˆå¯åŒ…å« tagï¼‰ |
| çº¿ç¨‹å®‰å…¨æ€§ | âœ… æ”¯æŒå¹¶å‘è®¿é—® |
| å†…æ ¸ç‰ˆæœ¬å¼•å…¥ | v4.20+ |
| å½“å‰çŠ¶æ€ | å·²å¹¿æ³›æ›¿ä»£æ—§ç»“æ„ï¼ˆv5.x ~ v6.xï¼‰ |


# `struct address_space` æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ

è¿™æ˜¯ Linux å†…æ ¸ä¸­ä¸€ä¸ª**éå¸¸é‡è¦ä¸”æ ¸å¿ƒçš„æ•°æ®ç»“æ„**ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿã€å†…å­˜ç®¡ç†ã€è™šæ‹Ÿå†…å­˜å­ç³»ç»Ÿç­‰å¤šä¸ªæ¨¡å—ä¸­éƒ½æœ‰å¹¿æ³›åº”ç”¨ã€‚

---

## âœ… ç®€çŸ­å›ç­”ï¼š

> `struct address_space` æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºæè¿° **æ–‡ä»¶ï¼ˆæˆ–å—è®¾å¤‡ï¼‰ä¸å†…å­˜ä¹‹é—´çš„æ˜ å°„å…³ç³»** çš„ç»“æ„ä½“ã€‚  
> å®ƒä¸»è¦ç”¨äºï¼š
>
> - ç®¡ç†æ–‡ä»¶çš„ **page cache**
> - è·Ÿè¸ªå“ªäº›è¿›ç¨‹å°†è¯¥æ–‡ä»¶ **mmap åˆ°è‡ªå·±çš„åœ°å€ç©ºé—´**
> - æ§åˆ¶æ–‡ä»¶é¡µçš„è¯»å†™ã€å›æ”¶ã€å›å†™ç­‰æ“ä½œ

ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š**â€œä¸€ä¸ªæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„ç¼“å­˜å’Œä½¿ç”¨çŠ¶æ€â€** çš„æŠ½è±¡è¡¨ç¤ºã€‚

---

## ğŸ“š ç»“æ„ä½“å®šä¹‰ï¼ˆç®€åŒ–ç‰ˆï¼‰

ä»¥ä¸‹æ˜¯ `struct address_space` çš„ä¸»è¦å­—æ®µï¼ˆLinux v6.x ä¸­å®šä¹‰äº `include/linux/fs.h`ï¼‰ï¼š

```c
struct address_space {
    struct inode        *host;       // æ‹¥æœ‰è¿™ä¸ª address_space çš„ inode
    struct xarray       i_pages;     // æ›¿ä»£æ—§çš„ radix_treeï¼Œå­˜å‚¨ page cache
    unsigned long       nrpages;     // å½“å‰ç¼“å­˜çš„é¡µæ•°
    pgoff_t             writeback_index; // ä¸‹ä¸€ä¸ªè¦å†™å›ç£ç›˜çš„é¡µç´¢å¼•
    const struct address_space_operations *a_ops; // æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå‡½æ•°æŒ‡é’ˆ
    struct mutex        invalidate_lock;  // é”ï¼Œä¿æŠ¤ invalidate æ“ä½œ
    struct rb_root_cached i_mmap;       // æ‰€æœ‰æ˜ å°„è¯¥æ–‡ä»¶çš„ VMAï¼ˆè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼‰
    ...
};
```

---

## ğŸ” ä¸»è¦ä½œç”¨è¯¦è§£

### 1. ğŸ—‚ï¸ ç®¡ç† Page Cache

- `i_pages` å­—æ®µæ˜¯ä¸€ä¸ª `xarray`ï¼ˆä»¥å‰æ˜¯ `radix_tree`ï¼‰ï¼Œç”¨æ¥å­˜å‚¨æ–‡ä»¶å¯¹åº”çš„ç¼“å­˜é¡µï¼ˆ`struct page *` æˆ– `struct folio *`ï¼‰ã€‚
- æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ª `address_space` å®ä¾‹ï¼Œè´Ÿè´£ç®¡ç†å…¶æ‰€æœ‰è¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„é¡µã€‚

#### ç¤ºä¾‹ï¼š
å½“ä½ æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

```c
int fd = open("test.txt", O_RDONLY);
read(fd, buf, len);  // è¯»å–å†…å®¹
```

å†…æ ¸ä¼šæŠŠæ–‡ä»¶å†…å®¹è¯»å…¥å†…å­˜ï¼Œå¹¶é€šè¿‡ `address_space` æ¥ç®¡ç†è¿™äº›ç¼“å­˜é¡µã€‚

---

### 2. ğŸ§  è¿½è¸ªè°æ˜ å°„äº†è¿™ä¸ªæ–‡ä»¶ï¼ˆ`i_mmap`ï¼‰

- `i_mmap` æ˜¯ä¸€æ£µçº¢é»‘æ ‘ï¼ˆ`rb_root`ï¼‰ï¼Œä¿å­˜äº†æ‰€æœ‰å°†è¯¥æ–‡ä»¶ mmap åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„ VMAï¼ˆVirtual Memory Areaï¼‰ã€‚
- æ¯å½“ä¸€ä¸ªè¿›ç¨‹é€šè¿‡ `mmap()` å°†æ–‡ä»¶æ˜ å°„è¿›å†…å­˜æ—¶ï¼Œå®ƒçš„ VMA å°±ä¼šè¢«æ’å…¥è¿™æ£µæ ‘ä¸­ã€‚

#### ç¤ºä¾‹ï¼š
å½“ä½ æ‰§è¡Œï¼š

```c
void *addr = mmap(NULL, length, PROT_READ, MAP_SHARED, fd, offset);
```

å†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ª VMA å¹¶æ·»åŠ åˆ°è¯¥æ–‡ä»¶çš„ `i_mmap` æ ‘ä¸­ã€‚

---

### 3. ğŸ”„ æ”¯æŒæ–‡ä»¶å›å†™ï¼ˆwritebackï¼‰

- `writeback_index` å­—æ®µè®°å½•ä¸‹ä¸€ä¸ªéœ€è¦å†™å›åˆ°ç£ç›˜çš„é¡µç´¢å¼•ã€‚
- å¦‚æœæ–‡ä»¶è¢«ä¿®æ”¹ï¼ˆå¦‚è°ƒç”¨ `write()` æˆ– mmap åä¿®æ”¹å†…å®¹ï¼‰ï¼Œè¿™äº›è„é¡µä¼šæ ‡è®°ä¸º dirtyï¼Œå¹¶ç”±å†…æ ¸çš„ pdflush / kthread åœ¨é€‚å½“æ—¶å€™å†™å›ç£ç›˜ã€‚

---

### 4. ğŸ§± æä¾›æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œæ¥å£ï¼ˆ`a_ops`ï¼‰

- `a_ops` æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè¡¨ï¼ŒæŒ‡å‘ä¸€ç»„æ–‡ä»¶ç³»ç»Ÿæä¾›çš„æ“ä½œå‡½æ•°ï¼Œä¾‹å¦‚ï¼š
  - `readpage()` â€”â€” ä»ç£ç›˜è¯»ä¸€é¡µå†…å®¹
  - `writepage()` â€”â€” æŠŠä¸€é¡µå†…å®¹å†™å›ç£ç›˜
  - `set_page_dirty()` â€”â€” æ ‡è®°é¡µä¸ºè„
  - `releasepage()` â€”â€” é¡µé¢é‡Šæ”¾æ—¶çš„æ“ä½œ

ä¸åŒæ–‡ä»¶ç³»ç»Ÿï¼ˆext4ã€tmpfsã€procã€sysfs ç­‰ï¼‰å¯ä»¥å®ç°è‡ªå·±çš„ `address_space_operations`ã€‚

---

### 5. ğŸ” åŒæ­¥é”æœºåˆ¶ï¼ˆå¦‚ `invalidate_lock`ï¼‰

- `invalidate_lock` ç”¨äºä¿æŠ¤å¯¹ `i_pages` çš„æ¸…ç†æ“ä½œï¼ˆå¦‚æˆªæ–­æ–‡ä»¶æˆ–è°ƒç”¨ `posix_fadvise(... DONTNEED)`ï¼‰ã€‚
- é˜²æ­¢åœ¨æ¸…ç†ç¼“å­˜æ—¶å‘ç”Ÿå¹¶å‘è®¿é—®é”™è¯¯ã€‚

---

## ğŸ§© ä¸å…¶ä»–ç»“æ„çš„å…³ç³»å›¾è§£

```
struct file
     â†“
struct inode
     â†“
struct address_space   â†â€”â€” (this is what we're talking about!)
     â†“
struct xarray i_pages â†’ å­˜å‚¨æ–‡ä»¶çš„ page cache
     â†“
struct rb_root_cached i_mmap â†’ è®°å½•å“ªäº›è¿›ç¨‹ mmap äº†è¿™ä¸ªæ–‡ä»¶
```

æ‰€ä»¥ï¼š
- ä¸€ä¸ª `file` å¯¹åº”ä¸€ä¸ª `inode`
- ä¸€ä¸ª `inode` åŒ…å«ä¸€ä¸ª `address_space`
- `address_space` ç®¡ç† page cache å’Œå†…å­˜æ˜ å°„

---

## ğŸ§ª å…¸å‹åº”ç”¨åœºæ™¯

| åœºæ™¯ | å¦‚ä½•ä½¿ç”¨ `address_space` |
|------|--------------------------|
| æ–‡ä»¶è¯»å– | ç¼“å­˜é¡µé€šè¿‡ `address_space` ç®¡ç† |
| æ–‡ä»¶å†™å…¥ | ä¿®æ”¹çš„é¡µæ ‡è®°ä¸º dirtyï¼Œåç»­å¼‚æ­¥å†™å› |
| mmap æ˜ å°„ | VMA æ·»åŠ åˆ° `i_mmap` çº¢é»‘æ ‘ |
| æˆªæ–­æ–‡ä»¶ | æ¸…é™¤å¯¹åº” `address_space` ä¸­çš„é¡µ |
| é¡µé¢å›æ”¶ï¼ˆreclaimï¼‰ | æ£€æŸ¥ `i_mmap` åˆ¤æ–­æ˜¯å¦å¯å›æ”¶ |
| ç”¨æˆ·è°ƒç”¨ `posix_fadvise(... POSIX_FADV_DONTNEED)` | è°ƒç”¨ `invalidate_inode_pages2()` æ¸…ç©º cache |

---

## ğŸ§  å¸¸è§è¯¯åŒºæ¾„æ¸…

| è¯¯è§£ | æ­£ç¡®è®¤è¯† |
|------|-----------|
| `address_space` åªç”¨äºæ–‡ä»¶ | âŒ å®ƒä¹Ÿç”¨äºè®¾å¤‡ã€å…±äº«å†…å­˜ç­‰åœºæ™¯ |
| `address_space` ç®¡ç†æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹ | âŒ å®ƒåªç®¡ç†å½“å‰è¢«ç¼“å­˜æˆ–æ˜ å°„çš„éƒ¨åˆ† |
| å®ƒæ˜¯ per-process çš„ | âŒ å®ƒæ˜¯ per-inode çš„ï¼Œå¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ä¸ª `address_space` |
| å®ƒå’Œç”¨æˆ·ç©ºé—´æœ‰å…³ | âŒ å®ƒæ˜¯å®Œå…¨çš„å†…æ ¸ç»“æ„ï¼Œä¸æš´éœ²ç»™ç”¨æˆ· |

---

## ğŸ§ª ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼ˆå†…æ ¸æ¨¡å—ï¼‰

```c
struct address_space *mapping = file->f_mapping;

// è·å–æ–‡ä»¶å¤§å°
loff_t size = i_size_read(mapping->host);

// æŸ¥çœ‹å½“å‰ç¼“å­˜äº†å¤šå°‘é¡µ
pr_info("Cached pages: %lu\n", mapping->nrpages);

// éå†æ‰€æœ‰ç¼“å­˜é¡µï¼ˆç®€åŒ–ç‰ˆï¼‰
unsigned long index = 0;
while (index < mapping->nrpages) {
    struct page *page = read_cache_page(mapping, index, NULL, NULL);
    if (!IS_ERR(page)) {
        pr_info("Page at %lu loaded\n", index);
        put_page(page);
    }
    index++;
}
```

---

## ğŸ“Œ æ€»ç»“

| åŠŸèƒ½ | æè¿° |
|------|------|
| åç§° | `struct address_space` |
| æ‰€å±ç»“æ„ | `struct inode` |
| ä¸»è¦ç”¨é€” | ç®¡ç†æ–‡ä»¶çš„ page cache å’Œå†…å­˜æ˜ å°„ |
| æ ¸å¿ƒå­—æ®µ | `i_pages`ï¼ˆç¼“å­˜é¡µï¼‰ã€`i_mmap`ï¼ˆVMA æ ‘ï¼‰ |
| æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ | é€šè¿‡ `a_ops` æ¥å£å®ç° |
| ä½¿ç”¨åœºæ™¯ | mmapã€read/writeã€truncateã€reclaimã€sync |
| é‡è¦æ€§ | â­â­â­â­â­ï¼ˆéå¸¸æ ¸å¿ƒï¼‰ |

---

## ğŸ§© æƒ³è¿›ä¸€æ­¥äº†è§£ï¼Ÿ

å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œæˆ‘å¯ä»¥ä¸ºä½ æä¾›ï¼š

- `address_space` çš„å®Œæ•´æºç åˆ†æï¼ˆv6.xï¼‰
- å¦‚ä½•ç¼–å†™ä¸€ä¸ªå†…æ ¸æ¨¡å—æ¥éå† `i_pages` å’Œ `i_mmap`
- `address_space` åœ¨ tmpfsã€ext4ã€ramfs ç­‰æ–‡ä»¶ç³»ç»Ÿä¸­çš„å·®å¼‚
- ç”¨æˆ·ç¨‹åºå¦‚ä½•å½±å“ `address_space` çš„è¡Œä¸ºï¼ˆå¦‚ mmapã€readaheadï¼‰

æ¬¢è¿ç»§ç»­æé—®ï¼



# /proc/<pid>/pagemapçš„æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ

`/proc/<pid>/pagemap` æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºä»ç”¨æˆ·ç©ºé—´è®¿é—®è¿›ç¨‹çš„ç‰©ç†å†…å­˜æ˜ å°„ä¿¡æ¯ã€‚å®ƒå…è®¸ä½ æŸ¥è¯¢æŸä¸ªè™šæ‹Ÿåœ°å€æ˜¯å¦è¢«æ˜ å°„ã€å¯¹åº”çš„ç‰©ç†é¡µå¸§å·ï¼ˆPFNï¼‰ã€æ˜¯å¦æ˜¯è„é¡µã€æ˜¯å¦è¢«ä¿®æ”¹ç­‰ã€‚

---

## ğŸ§¾ `/proc/<pid>/pagemap` çš„æ ¼å¼è¯´æ˜

### âœ… æ–‡ä»¶è·¯å¾„ï¼š
```
/proc/<pid>/pagemap
```

- æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ `pagemap` æ–‡ä»¶ã€‚
- å®ƒæ˜¯ä¸€ä¸ªåªè¯»äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
- æ¯ä¸ªè™šæ‹Ÿé¡µå¯¹åº” 8 å­—èŠ‚ï¼ˆ64ä½ï¼‰çš„æ•°æ®ç»“æ„ã€‚

---

## ğŸ“š æ¯ä¸ªæ¡ç›®ï¼ˆæ¯ä¸ªè™šæ‹Ÿé¡µï¼‰çš„æ ¼å¼ï¼ˆå…± 64 ä½ï¼‰

| ä½ | åç§° | å«ä¹‰ |
|----|------|------|
| 0 | present | é¡µæ˜¯å¦åœ¨å†…å­˜ä¸­ï¼ˆ1 = å­˜åœ¨ï¼Œ0 = ä¸å­˜åœ¨ï¼‰ |
| 1 | swapped | æ˜¯å¦è¢«äº¤æ¢åˆ° swapï¼ˆ1 = è¢«æ¢å‡ºï¼‰ |
| 2-54 | pfn | ç‰©ç†é¡µå¸§å·ï¼ˆPage Frame Numberï¼‰ï¼Œå¦‚æœ present=1 |
| 55 | soft_dirty | è¯¥é¡µæ˜¯å¦è¢«æ ‡è®°ä¸ºâ€œsoft dirtyâ€ï¼ˆç”¨äºè¿½è¸ª fork åçš„å†™æ“ä½œï¼‰ |
| 56 | file_page | 1 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶æ˜ å°„é¡µï¼ˆéåŒ¿åé¡µï¼‰ |
| 57 | swapped_shared | å¦‚æœè®¾ç½®äº† `swapped`ï¼Œè¡¨ç¤ºè¿™ä¸ªé¡µå±äºå…±äº«å†…å­˜ï¼ˆå¦‚ tmpfs æˆ– shmï¼‰ |
| 58-60 | page_idle | idle æ ‡å¿—ï¼ˆç”¨äº idle trackingï¼‰ |
| 61-63 | flags | é¢„ç•™å­—æ®µ |

> âš ï¸ æ³¨æ„ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰ä½éƒ½åœ¨æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬ä¸­éƒ½å¯ç”¨ï¼Œå…·ä½“æ”¯æŒå–å†³äºä½ çš„å†…æ ¸é…ç½®ã€‚

---

## ğŸ” ç¤ºä¾‹è§£é‡Šï¼š

å‡è®¾ä½ è¯»å–äº† 8 å­—èŠ‚çš„å†…å®¹ï¼Œå…¶å€¼ä¸ºï¼š

```
0x7F00000000000123
```

ä½ å¯ä»¥å°†å…¶æ‹†åˆ†ä¸ºï¼š

```
äºŒè¿›åˆ¶ï¼š0111 1111 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0001 0010 0011
        ^^^^^^^^ ...                                         ^^^^^^^^^^^^^^^^^^
        ä¿ç•™ä½                                               PFN (ä½ 52 ä½)
        present = 1, swapped = 0, file_page = 0 ...
```

è¿™æ„å‘³ç€ï¼š
- è¯¥é¡µå­˜åœ¨ï¼ˆpresent = 1ï¼‰
- æœªè¢«äº¤æ¢å‡ºå»ï¼ˆswapped = 0ï¼‰
- æ˜¯åŒ¿åé¡µï¼ˆfile_page = 0ï¼‰
- å¯¹åº”çš„ç‰©ç†é¡µå¸§å·æ˜¯ `0x123`ï¼ˆå³ 291ï¼‰
- é¡µé¢å¤§å°é€šå¸¸æ˜¯ 4KBï¼Œæ‰€ä»¥å¯¹åº”çš„ç‰©ç†åœ°å€æ˜¯ `0x123 * 4096`

---

## ğŸ› ï¸ å¦‚ä½•ä½¿ç”¨ `/proc/<pid>/pagemap`

### æ­¥éª¤ï¼š

1. **è·å–è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€èŒƒå›´**  
   ä½¿ç”¨ `/proc/<pid>/maps` è·å–è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼‰ã€‚

2. **è®¡ç®—éœ€è¦è¯»å–çš„åç§»é‡**  
   æ¯ä¸ªè™šæ‹Ÿé¡µå¯¹åº”ä¸€ä¸ª 8 å­—èŠ‚çš„æ¡ç›®ï¼Œæ‰€ä»¥åç§»é‡æ˜¯ï¼š
   ```
   offset = virtual_page_number * sizeof(uint64_t)
   ```

3. **è¯»å– pagemap æ¡ç›®**  
   ä½¿ç”¨ `pread()` å‡½æ•°è¯»å–æŒ‡å®šåç§»å¤„çš„ 8 å­—èŠ‚æ•°æ®ã€‚

4. **è§£ææ ‡å¿—ä½å’Œ PFN**

---

## ğŸ’¡ ç¤ºä¾‹ä»£ç ï¼ˆCè¯­è¨€ï¼‰

```c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <stdint.h>

int main(int argc, char *argv[]) {
    if (argc != 3) {
        fprintf(stderr, "Usage: %s <pid> <virtual_addr>\n", argv[0]);
        return -1;
    }

    pid_t pid = atoi(argv[1]);
    uint64_t vaddr = strtoull(argv[2], NULL, 16);

    // è·å–ç³»ç»Ÿé¡µé¢å¤§å°
    uint64_t pagesize = getpagesize();
    uint64_t vpn = vaddr / pagesize;

    // æ‰“å¼€ pagemap
    char pagemap_path[256];
    snprintf(pagemap_path, sizeof(pagemap_path), "/proc/%d/pagemap", pid);
    int fd = open(pagemap_path, O_RDONLY);
    if (fd < 0) {
        perror("open");
        return -1;
    }

    // å®šä½åˆ°å¯¹åº”çš„ pagemap entry
    uint64_t entry;
    off_t offset = vpn * sizeof(entry);
    ssize_t bytes_read = pread(fd, &entry, sizeof(entry), offset);
    if (bytes_read != sizeof(entry)) {
        perror("pread");
        close(fd);
        return -1;
    }

    // è§£æ entry
    uint64_t present = (entry >> 0) & 0x1;
    uint64_t pfn = (entry >> 0) & ((1ULL << 54) - 1); // 52-bit PFN
    uint64_t dirty = (entry >> 55) & 0x1; // ç¬¬ 55 ä½æ˜¯ soft-dirtyï¼ˆä¸æ˜¯çœŸæ­£çš„ dirtyï¼‰
    uint64_t file_page = (entry >> 56) & 0x1;

    printf("Present: %llu\n", present);
    printf("File page: %llu\n", file_page);
    printf("Soft Dirty: %llu\n", dirty);
    if (present)
        printf("Physical Frame Number (PFN): 0x%llx\n", (unsigned long long)pfn);

    close(fd);
    return 0;
}
```

---

## ğŸ§ª å¦‚ä½•è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Ÿ

ç¼–è¯‘ï¼š
```bash
gcc pagemap.c -o pagemap
```

è¿è¡Œï¼ˆä¾‹å¦‚æŸ¥çœ‹è¿›ç¨‹ 1234 ä¸­åœ°å€ `0x7f00000000` çš„çŠ¶æ€ï¼‰ï¼š
```bash
./pagemap 1234 7f00000000
```

---

## ğŸ“Œ å°è´´å£«

- ä½ éœ€è¦ root æƒé™æ‰èƒ½è®¿é—®å…¶ä»–è¿›ç¨‹çš„ `pagemap`ï¼›
- å¯ä»¥ç»“åˆ `/proc/<pid>/maps` è·å–è¿›ç¨‹çš„ VMA åŒºåŸŸï¼›
- `pagemap` æ˜¯è°ƒè¯•å†…å­˜è¡Œä¸ºçš„é‡è¦å·¥å…·ï¼Œå¸¸ç”¨äºï¼š
  - åˆ†æå†…å­˜æ³„æ¼
  - ç›‘æ§ mmap æ–‡ä»¶çš„ç¼“å­˜æƒ…å†µ
  - æŸ¥çœ‹å“ªäº›é¡µæ˜¯è„é¡µï¼ˆéœ€é…åˆå…¶ä»–æ‰‹æ®µï¼‰

---

## âœ… æ€»ç»“

| å†…å®¹ | è¯´æ˜ |
|------|------|
| æ–‡ä»¶ä½ç½® | `/proc/<pid>/pagemap` |
| æ¯ä¸ªæ¡ç›®é•¿åº¦ | 8 å­—èŠ‚ï¼ˆ64 bitï¼‰ |
| å…³é”®å­—æ®µ | present, pfn, dirty, file_page ç­‰ |
| ç”¨é€” | æŸ¥çœ‹è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µä¿¡æ¯ |
| ç”¨æˆ·æ€è®¿é—®æ–¹å¼ | ä½¿ç”¨ `pread()` è¯»å–ç‰¹å®šåç§»å¤„çš„æ•°æ® |
| æ˜¯å¦å¯ä»¥åˆ¤æ–­è„é¡µï¼Ÿ | `soft-dirty` æ˜¯ä¸€ç§è¿‘ä¼¼åˆ¤æ–­æ–¹æ³•ï¼Œä½†ä¸æ˜¯çœŸå®çš„ dirty flag |

---

å¦‚æœä½ æƒ³è¦ä¸€ä¸ª Python å®ç°çš„è„šæœ¬æˆ–æƒ³äº†è§£å¦‚ä½•ç»“åˆ `/proc/self/pagemap` åšå†…å­˜åˆ†æï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»§ç»­ä¸ºä½ æä¾›å®Œæ•´ä»£ç ã€‚æ¬¢è¿ç»§ç»­æé—®ï¼

# åº”ç”¨å†…å­˜æƒ…å†µ

## å°çº¢ä¹¦å’ŒUC

```bash
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 3554
  Present: 38105 pages (148.85 MB)
  Absent: 11627668 pages (45420.58 MB)

  FilePage: 32080 pages (125.31 MB)
    shared: 660 pages (2.58 MB)
    private: 31420 pages (122.73 MB)
    dirty: 0 pages (0.00 MB)
    clean: 32080 pages (125.31 MB)
    private & clean: 31420 pages (122.73 MB)
  NonFilePage: 6025 pages (23.54 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 6025 pages (23.54 MB)
Private File + Anonymous Total:
  Total: 6025 pages (23.54 MB)
âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep web
u10_i9023      721  4365 0 15:48:53 ?     00:00:00 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
u10_i9024     3094  4365 0 15:49:06 ?     00:00:00 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
u10_i9029     3586  4365 0 16:53:42 ?     00:00:00 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
webview_zygote 4365 1524 0 19:47:02 ?     00:00:00 webview_zygote
u10_i9010     4618  4365 0 22:45:06 ?     00:00:01 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
u10_i9030    10541  4365 0 17:03:02 ?     00:00:00 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
u0_a181      12002  1524 0 19:48:00 ?     00:00:01 com.google.android.webview:webview_service
u10_a181     17181  1524 0 19:48:37 ?     00:00:02 com.google.android.webview:webview_service
u10_a309     17739  1524 2 16:20:51 ?     00:01:43 com.tencent.mm:xweb_privileged_process_0
u10_i9028    17766  1524 4 16:20:51 ?     00:02:40 com.tencent.mm:xweb_sandboxed_process_0:com.tencent.xweb.pinus.sdk.process.SandboxedProcessService
u10_i9031    19782  4365 0 17:17:30 ?     00:00:00 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
u0_i9008     24902  4365 0 22:37:06 ?     00:00:01 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
u10_a181     30125  1524 0 22:42:24 ?     00:00:01 com.google.android.webview:webview_apk
u10_i9032    31575  4365 1 17:31:26 ?     00:00:00 com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0
âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep uc
root           613     2 0 19:46:39 ?     00:00:00 [cpucp_wq]
root          1239     2 0 19:46:41 ?     00:00:00 [xiaomi_touch_temp_thread]
root          1249     2 0 19:46:41 ?     00:00:00 [ipa_uc_holb_wq]
system        1915     1 1 19:46:48 ?     00:12:12 vendor.xiaomi.hw.touchfeature-service
root          2710     1 0 19:46:51 ?     00:00:10 toucheventcheck
u0_a123       5672  1524 0 22:48:34 ?     00:00:02 com.xiaomi.aicr:instruction
system        6986  1524 0 19:47:28 ?     00:00:01 com.xiaomi.touchservice
u10_a123     18369  1524 0 07:20:47 ?     00:00:01 com.xiaomi.aicr:instruction
u10_system   30535  1524 0 20:20:47 ?     00:00:01 com.miui.touchassistant
âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep UC
u10_a313      5499  1524 2 15:49:17 ?     00:01:37 com.UCMobile
u10_a313      6472  1524 0 22:50:10 ?     00:00:22 com.UCMobile:push
u10_a313     18948  1524 0 23:29:12 ?     00:00:24 com.UCMobile:DownloadService
u10_a313     32014  1524 0 22:42:32 ?     00:01:43 com.UCMobile:channel
u10_a313     32041  1524 32 17:31:29 ?    00:00:21 com.UCMobile:MediaPlayerService
u10_a313     32270  1524 2 17:31:30 ?     00:00:01 com.UCMobile:gpu_process
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 5499
  Present: 39477 pages (154.21 MB)
  Absent: 28020492 pages (109455.05 MB)

  FilePage: 33138 pages (129.45 MB)
    shared: 0 pages (0.00 MB)
    private: 33138 pages (129.45 MB)
    dirty: 0 pages (0.00 MB)
    clean: 33138 pages (129.45 MB)
    private & clean: 33138 pages (129.45 MB)
  NonFilePage: 6339 pages (24.76 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 843 pages (3.29 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 6339 pages (24.76 MB)
Private File + Anonymous Total:
  Total: 7182 pages (28.05 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 6472
fopen maps: No such file or directory
âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep UC
u10_a313      5499  1524 3 15:49:17 ?     00:03:26 com.UCMobile
u10_a313      7813  1524 8 17:34:29 ?     00:00:01 com.UCMobile:push
u10_a313     18948  1524 0 23:29:12 ?     00:00:25 com.UCMobile:DownloadService
u10_a313     32014  1524 0 22:42:32 ?     00:01:44 com.UCMobile:channel
u10_a313     32041  1524 30 17:31:29 ?    00:01:00 com.UCMobile:MediaPlayerService
u10_a313     32270  1524 1 17:31:30 ?     00:00:02 com.UCMobile:gpu_process
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 7813
  Present: 20280 pages (79.22 MB)
  Absent: 5374178 pages (20992.88 MB)

  FilePage: 4288 pages (16.75 MB)
    shared: 0 pages (0.00 MB)
    private: 4288 pages (16.75 MB)
    dirty: 0 pages (0.00 MB)
    clean: 4288 pages (16.75 MB)
    private & clean: 4288 pages (16.75 MB)
  NonFilePage: 15992 pages (62.47 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 58 pages (0.23 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 15992 pages (62.47 MB)
Private File + Anonymous Total:
  Total: 16050 pages (62.70 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 18948
  Present: 12177 pages (47.57 MB)
  Absent: 5328891 pages (20815.98 MB)

  FilePage: 2661 pages (10.39 MB)
    shared: 1 pages (0.00 MB)
    private: 2660 pages (10.39 MB)
    dirty: 0 pages (0.00 MB)
    clean: 2661 pages (10.39 MB)
    private & clean: 2660 pages (10.39 MB)
  NonFilePage: 9516 pages (37.17 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 9516 pages (37.17 MB)
Private File + Anonymous Total:
  Total: 9516 pages (37.17 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 32014
  Present: 13847 pages (54.09 MB)
  Absent: 5329788 pages (20819.48 MB)

  FilePage: 4791 pages (18.71 MB)
    shared: 2 pages (0.01 MB)
    private: 4789 pages (18.71 MB)
    dirty: 0 pages (0.00 MB)
    clean: 4791 pages (18.71 MB)
    private & clean: 4789 pages (18.71 MB)
  NonFilePage: 9056 pages (35.38 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 9056 pages (35.38 MB)
Private File + Anonymous Total:
  Total: 9056 pages (35.38 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 32041
  Present: 22990 pages (89.80 MB)
  Absent: 5444300 pages (21266.80 MB)

  FilePage: 5660 pages (22.11 MB)
    shared: 0 pages (0.00 MB)
    private: 5660 pages (22.11 MB)
    dirty: 0 pages (0.00 MB)
    clean: 5660 pages (22.11 MB)
    private & clean: 5660 pages (22.11 MB)
  NonFilePage: 17330 pages (67.70 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 1 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 17330 pages (67.70 MB)
Private File + Anonymous Total:
  Total: 17331 pages (67.70 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 32270
  Present: 10169 pages (39.72 MB)
  Absent: 8933569 pages (34896.75 MB)

  FilePage: 3888 pages (15.19 MB)
    shared: 0 pages (0.00 MB)
    private: 3888 pages (15.19 MB)
    dirty: 0 pages (0.00 MB)
    clean: 3888 pages (15.19 MB)
    private & clean: 3888 pages (15.19 MB)
  NonFilePage: 6281 pages (24.54 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 6281 pages (24.54 MB)
Private File + Anonymous Total:
  Total: 6281 pages (24.54 MB)
```

## è…¾è®¯ï¼ˆQQ + å¾®ä¿¡ï¼‰

```bash

âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep tencent
u0_a172       7181  1524 0 19:47:30 ?     00:00:01 com.tencent.soter.soterserver
u10_a302     16080  1524 0 19:48:32 ?     00:03:46 com.tencent.mobileqq:MSF
u10_a309     17237  1524 1 16:20:50 ?     00:01:00 com.tencent.mm:appbrand1
u10_a309     17739  1524 2 16:20:51 ?     00:01:43 com.tencent.mm:xweb_privileged_process_0
u10_i9028    17766  1524 3 16:20:51 ?     00:02:40 com.tencent.mm:xweb_sandboxed_process_0:com.tencent.xweb.pinus.sdk.process.SandboxedProcessService
u10_a309     18194  1524 0 19:48:42 ?     00:03:41 com.tencent.mm:push
u10_a309     23765  1524 1 23:06:09 ?     00:15:13 com.tencent.mm
u10_a302     29021  1524 0 22:42:01 ?     00:02:40 com.tencent.mobileqq
u10_a172     30085  1524 0 16:30:39 ?     00:00:00 com.tencent.soter.soterserver
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 29021
  Present: 20674 pages (80.76 MB)
  Absent: 1096464 pages (4283.06 MB)

  FilePage: 9873 pages (38.57 MB)
    shared: 37 pages (0.14 MB)
    private: 9836 pages (38.42 MB)
    dirty: 0 pages (0.00 MB)
    clean: 9873 pages (38.57 MB)
    private & clean: 9836 pages (38.42 MB)
  NonFilePage: 10801 pages (42.19 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 2 pages (0.01 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 5 pages (0.02 MB)
Anonymous Pages:
  Total: 10801 pages (42.19 MB)
Private File + Anonymous Total:
  Total: 10803 pages (42.20 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 16080
  Present: 14276 pages (55.77 MB)
  Absent: 1374243 pages (5368.14 MB)

  FilePage: 8026 pages (31.35 MB)
    shared: 6 pages (0.02 MB)
    private: 8020 pages (31.33 MB)
    dirty: 0 pages (0.00 MB)
    clean: 8026 pages (31.35 MB)
    private & clean: 8020 pages (31.33 MB)
  NonFilePage: 6250 pages (24.41 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 6250 pages (24.41 MB)
Private File + Anonymous Total:
  Total: 6250 pages (24.41 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 18194
  Present: 17877 pages (69.83 MB)
  Absent: 1121092 pages (4379.27 MB)

  FilePage: 8268 pages (32.30 MB)
    shared: 1 pages (0.00 MB)
    private: 8267 pages (32.29 MB)
    dirty: 0 pages (0.00 MB)
    clean: 8268 pages (32.30 MB)
    private & clean: 8267 pages (32.29 MB)
  NonFilePage: 9609 pages (37.54 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 1160 pages (4.53 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 9609 pages (37.54 MB)
Private File + Anonymous Total:
  Total: 10769 pages (42.07 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 17739
fopen maps: No such file or directory
âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep tencent
u0_a172       7181  1524 0 19:47:29 ?     00:00:01 com.tencent.soter.soterserver
u10_a302     16080  1524 0 19:48:31 ?     00:03:48 com.tencent.mobileqq:MSF
u10_a309     17237  1524 1 16:20:49 ?     00:01:02 com.tencent.mm:appbrand1
u10_a309     18194  1524 0 19:48:41 ?     00:03:44 com.tencent.mm:push
u10_a309     21857  1524 16 17:45:03 ?    00:00:05 com.tencent.mm:appbrand0
u10_a309     23765  1524 1 23:06:08 ?     00:15:24 com.tencent.mm
u10_a302     29021  1524 0 22:42:00 ?     00:02:45 com.tencent.mobileqq
u10_a172     30085  1524 0 16:30:38 ?     00:00:00 com.tencent.soter.soterserver
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 17237
  Present: 21838 pages (85.30 MB)
  Absent: 28056627 pages (109596.20 MB)

  FilePage: 9109 pages (35.58 MB)
    shared: 218 pages (0.85 MB)
    private: 8891 pages (34.73 MB)
    dirty: 0 pages (0.00 MB)
    clean: 9109 pages (35.58 MB)
    private & clean: 8891 pages (34.73 MB)
  NonFilePage: 12729 pages (49.72 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 2 pages (0.01 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 12729 pages (49.72 MB)
Private File + Anonymous Total:
  Total: 12731 pages (49.73 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 21857
  Present: 29913 pages (116.85 MB)
  Absent: 91882645 pages (358916.58 MB)

  FilePage: 18002 pages (70.32 MB)
    shared: 0 pages (0.00 MB)
    private: 18002 pages (70.32 MB)
    dirty: 0 pages (0.00 MB)
    clean: 18002 pages (70.32 MB)
    private & clean: 18002 pages (70.32 MB)
  NonFilePage: 11911 pages (46.53 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 11911 pages (46.53 MB)
Private File + Anonymous Total:
  Total: 11911 pages (46.53 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 30085
  Present: 6406 pages (25.02 MB)
  Absent: 708605 pages (2767.99 MB)

  FilePage: 102 pages (0.40 MB)
    shared: 0 pages (0.00 MB)
    private: 102 pages (0.40 MB)
    dirty: 0 pages (0.00 MB)
    clean: 102 pages (0.40 MB)
    private & clean: 102 pages (0.40 MB)
  NonFilePage: 6304 pages (24.62 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 2 pages (0.01 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 6304 pages (24.62 MB)
Private File + Anonymous Total:
  Total: 6306 pages (24.63 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 7181
  Present: 6269 pages (24.49 MB)
  Absent: 708742 pages (2768.52 MB)

  FilePage: 5 pages (0.02 MB)
    shared: 0 pages (0.00 MB)
    private: 5 pages (0.02 MB)
    dirty: 0 pages (0.00 MB)
    clean: 5 pages (0.02 MB)
    private & clean: 5 pages (0.02 MB)
  NonFilePage: 6264 pages (24.47 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 6264 pages (24.47 MB)
Private File + Anonymous Total:
  Total: 6264 pages (24.47 MB)
âœ  ndk_template git:(master) âœ— adb shell ps -ef | grep tencent
u0_a172       7181  1524 0 19:47:29 ?     00:00:01 com.tencent.soter.soterserver
u10_a302     16080  1524 0 19:48:31 ?     00:03:49 com.tencent.mobileqq:MSF
u10_a309     17237  1524 1 16:20:49 ?     00:01:10 com.tencent.mm:appbrand1
u10_a309     18194  1524 0 19:48:41 ?     00:03:46 com.tencent.mm:push
u10_a309     21857  1524 2 17:45:03 ?     00:00:06 com.tencent.mm:appbrand0
u10_i9033    22950  1524 3 17:45:50 ?     00:00:09 com.tencent.mm:xweb_sandboxed_process_0:com.tencent.xweb.pinus.sdk.process.SandboxedProcessService
u10_a309     22971  1524 0 17:45:50 ?     00:00:01 com.tencent.mm:xweb_privileged_process_0
u10_a309     23765  1524 1 23:06:08 ?     00:15:50 com.tencent.mm
u10_a309     27571  1524 19 17:50:22 ?    00:00:02 com.tencent.mm:support
u10_a302     29021  1524 0 22:42:00 ?     00:02:47 com.tencent.mobileqq
u10_a172     30085  1524 0 16:30:38 ?     00:00:00 com.tencent.soter.soterserver
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 22950
  Present: 42978 pages (167.88 MB)
  Absent: 64152924 pages (250597.36 MB)

  FilePage: 34163 pages (133.45 MB)
    shared: 0 pages (0.00 MB)
    private: 34163 pages (133.45 MB)
    dirty: 0 pages (0.00 MB)
    clean: 34163 pages (133.45 MB)
    private & clean: 34163 pages (133.45 MB)
  NonFilePage: 8815 pages (34.43 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 8815 pages (34.43 MB)
Private File + Anonymous Total:
  Total: 8815 pages (34.43 MB)
âœ  ndk_template git:(master) âœ— adb shell /data/local/tmp/file_mem_stat 22971
  Present: 32455 pages (126.78 MB)
  Absent: 5481317 pages (21411.39 MB)

  FilePage: 10026 pages (39.16 MB)
    shared: 275 pages (1.07 MB)
    private: 9751 pages (38.09 MB)
    dirty: 0 pages (0.00 MB)
    clean: 10026 pages (39.16 MB)
    private & clean: 9751 pages (38.09 MB)
  NonFilePage: 22429 pages (87.61 MB)
Private File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Shared File Pages:
  Dirty: 0 pages (0.00 MB)
  Clean: 0 pages (0.00 MB)
Anonymous Pages:
  Total: 22429 pages (87.61 MB)
Private File + Anonymous Total:
  Total: 22429 pages (87.61 MB)

```